{"version":3,"sources":["file-types/image.js"],"names":["file","thumbPath","isGIF","suffix","Files","getImageSize","path","info","Promise","resolve","reject","stream","png","resize","max","toFile","err","thumbInfo","Error","Tools","translate","result","dimensions","width","height","thumbDimensions","hash","ihash","toString","createThumbnail","fileInfo","sizeText","renderPostFileInfo","match","suffixMatchesMimeType","defaultSuffixForMimeType","thumbnailSuffixForMimeType","MIME_TYPES_FOR_SUFFIXES","Map","DEFAULT_SUFFIXES_FOR_MIME_TYPES","THUMB_SUFFIXES_FOR_MIME_TYPE","defineMimeTypeSuffixes","mimeType","extensions","thumbSuffix","isArray","forEach","extension","set","isImageType","get"],"mappings":"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","file":"image.js","sourcesContent":["import _ from 'underscore';\nimport sharp from 'sharp';\nimport phash from 'phash-image';\n\nimport * as Files from '../core/files';\nimport config from '../helpers/config';\nimport * as Tools from '../helpers/tools';\n\nconst MIME_TYPES_FOR_SUFFIXES = new Map();\nconst DEFAULT_SUFFIXES_FOR_MIME_TYPES = new Map();\nconst THUMB_SUFFIXES_FOR_MIME_TYPE = new Map();\n\nfunction defineMimeTypeSuffixes(mimeType, extensions, thumbSuffix) {\n  if (!_(extensions).isArray()) {\n    extensions = [extensions];\n  }\n  extensions.forEach((extension) => { MIME_TYPES_FOR_SUFFIXES.set(extension, mimeType); });\n  DEFAULT_SUFFIXES_FOR_MIME_TYPES.set(mimeType, extensions[0]);\n  THUMB_SUFFIXES_FOR_MIME_TYPE.set(mimeType, thumbSuffix);\n}\n\ndefineMimeTypeSuffixes('image/gif', 'gif', 'png');\ndefineMimeTypeSuffixes('image/jpeg', ['jpeg', 'jpg']);\ndefineMimeTypeSuffixes('image/png', 'png');\n\nexport function match(mimeType) {\n  return Files.isImageType(mimeType);\n}\n\nexport function suffixMatchesMimeType(suffix, mimeType) {\n  return MIME_TYPES_FOR_SUFFIXES.get(suffix) === mimeType;\n}\n\nexport function defaultSuffixForMimeType(mimeType) {\n  return DEFAULT_SUFFIXES_FOR_MIME_TYPES.get(mimeType) || null;\n}\n\nexport function thumbnailSuffixForMimeType(mimeType) {\n  return THUMB_SUFFIXES_FOR_MIME_TYPE.get(mimeType);\n}\n\nexport async function createThumbnail(file, thumbPath) {\n  let isGIF = !1;//('image/gif' === file.mimeType);\n  let suffix = isGIF ? '[0]' : '';\n  let info = await Files.getImageSize(file.path + suffix);\n  await new Promise(async (resolve, reject) => {\n    let stream = sharp(file.path + suffix);\n    if (isGIF)\n      stream = stream.png();\n    stream.resize(200, 200).max().toFile(thumbPath, (err) => {\n      if (err) {\n        return reject(err);\n      }\n      resolve();\n    });\n  });\n  let thumbInfo = await Files.getImageSize(thumbPath);\n  if (!thumbInfo) {\n    throw new Error(Tools.translate('Failed to identify image file: $[1]', '', thumbPath));\n  }\n  let result = {\n    dimensions: {\n      width: info.width,\n      height: info.height\n    },\n    thumbDimensions: {\n      width: thumbInfo.width,\n      height: thumbInfo.height\n    }\n  };\n  if (config('system.phash.enabled')) {\n    let hash = await phash(thumbPath, true);\n    result.ihash = hash.toString();\n  }\n  return result;\n}\n\nexport async function renderPostFileInfo(fileInfo) {\n  if (fileInfo.dimensions) {\n    fileInfo.sizeText += `, ${fileInfo.dimensions.width}x${fileInfo.dimensions.height}`;\n  }\n  return fileInfo;\n}\n"]}