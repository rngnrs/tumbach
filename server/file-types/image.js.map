{"version":3,"sources":["file-types/image.js"],"names":["file","thumbPath","Files","getImageSize","path","info","Error","Tools","translate","Promise","resolve","reject","readFile","err","buffer","resize","background","r","g","b","alpha","embed","max","png","progressive","force","toFile","thumbInfo","result","dimensions","width","height","thumbDimensions","hash","ihash","toString","createThumbnail","fileInfo","sizeText","renderPostFileInfo","match","suffixMatchesMimeType","defaultSuffixForMimeType","thumbnailSuffixForMimeType","MIME_TYPES_FOR_SUFFIXES","Map","DEFAULT_SUFFIXES_FOR_MIME_TYPES","THUMB_SUFFIXES_FOR_MIME_TYPE","defineMimeTypeSuffixes","mimeType","extensions","thumbSuffix","isArray","forEach","extension","set","isImageType","suffix","get"],"mappings":"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","file":"image.js","sourcesContent":["import _ from 'underscore';\nimport sharp from 'sharp';\nimport phash from 'phash-image';\nimport FSSync from 'fs';\n\nimport * as Files from '../core/files';\nimport config from '../helpers/config';\nimport * as Tools from '../helpers/tools';\n\nconst MIME_TYPES_FOR_SUFFIXES = new Map();\nconst DEFAULT_SUFFIXES_FOR_MIME_TYPES = new Map();\nconst THUMB_SUFFIXES_FOR_MIME_TYPE = new Map();\n\nfunction defineMimeTypeSuffixes(mimeType, extensions, thumbSuffix) {\n  if (!_(extensions).isArray()) {\n    extensions = [extensions];\n  }\n  extensions.forEach((extension) => { MIME_TYPES_FOR_SUFFIXES.set(extension, mimeType); });\n  DEFAULT_SUFFIXES_FOR_MIME_TYPES.set(mimeType, extensions[0]);\n  THUMB_SUFFIXES_FOR_MIME_TYPE.set(mimeType, thumbSuffix);\n}\n\ndefineMimeTypeSuffixes('image/gif', 'gif', 'png');\ndefineMimeTypeSuffixes('image/jpeg', ['jpeg', 'jpg']);\ndefineMimeTypeSuffixes('image/png', 'png');\n\nexport function match(mimeType) {\n  return Files.isImageType(mimeType);\n}\n\nexport function suffixMatchesMimeType(suffix, mimeType) {\n  return MIME_TYPES_FOR_SUFFIXES.get(suffix) === mimeType;\n}\n\nexport function defaultSuffixForMimeType(mimeType) {\n  return DEFAULT_SUFFIXES_FOR_MIME_TYPES.get(mimeType) || null;\n}\n\nexport function thumbnailSuffixForMimeType(mimeType) {\n  return THUMB_SUFFIXES_FOR_MIME_TYPE.get(mimeType);\n}\n\nexport async function createThumbnail(file, thumbPath) {\n  let info = await Files.getImageSize(file.path);\n  if (!info) {\n    throw new Error(Tools.translate('Failed to identify image file: $[1]', '', thumbPath));\n  }\n  await new Promise(async (resolve, reject) => {\n    FSSync.readFile(file.path, (err, buffer) => {\n      sharp(buffer)\n        .resize(200, 200)\n        .background({r: 255, g: 255, b: 255, alpha: 0})\n        .embed()\n        .max()\n        .png({progressive: true, force: true})\n        .toFile(thumbPath, (err) => {\n          if (err) {\n            return reject(err);\n          }\n          resolve();\n        });\n    });\n  });\n  let thumbInfo = await Files.getImageSize(thumbPath);\n  if (!thumbInfo) {\n    throw new Error(Tools.translate('Failed to identify image file: $[1]', '', thumbPath));\n  }\n  let result = {\n    dimensions: {\n      width: info.width,\n      height: info.height\n    },\n    thumbDimensions: {\n      width: thumbInfo.width,\n      height: thumbInfo.height\n    }\n  };\n  if (config('system.phash.enabled')) {\n    let hash = await phash(thumbPath, true);\n    result.ihash = hash.toString();\n  }\n  return result;\n}\n\nexport async function renderPostFileInfo(fileInfo) {\n  if (fileInfo.dimensions) {\n    fileInfo.sizeText += `, ${fileInfo.dimensions.width}x${fileInfo.dimensions.height}`;\n  }\n  return fileInfo;\n}\n"]}