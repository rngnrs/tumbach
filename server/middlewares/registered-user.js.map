{"version":3,"sources":["middlewares/registered-user.js"],"names":["Tools","UsersModel","req","res","next","getRegisteredUserLevels","hashpass","levels","maxLevelIndex","toArray","map","level","REGISTERED_USER_LEVELS","indexOf","sort","level1","level2","maxLevel","boardName","test","strict","lvl","compareRegisteredUserLevels","forEach","Level","toLowerCase","charAt","toUpperCase","slice","bind","error","stack"],"mappings":";;;;;;AAAA;;;;AAEA;;;;AACA;;IAAYA,K;;AACZ;;IAAYC,U;;;;;;;;;uDAEG,kBAAeC,GAAf,EAAoBC,GAApB,EAAyBC,IAAzB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6BAEQH,WAAWI,uBAAX,CAAmCH,IAAII,QAAvC,CAFR;;AAAA;AAEPC,4BAFO;AAGPC,mCAHO,GAGS,0BAAED,MAAF,EAAUE,OAAV,GAAoBC,GAApB,CAAwB,UAACC,KAAD,EAAW;AACrD,+BAAOX,MAAMY,sBAAN,CAA6BC,OAA7B,CAAqCF,KAArC,CAAP;AACD,uBAFmB,EAEjBG,IAFiB,CAEZ,UAACC,MAAD,EAASC,MAAT,EAAoB;AAAE,+BAAOA,SAASD,MAAhB;AAAyB,uBAFnC,EAEqC,CAFrC,CAHT;AAMPE,8BANO,GAMIjB,MAAMY,sBAAN,CAA6BJ,aAA7B,KAA+C,IANnD;;AAOXN,0BAAIS,KAAJ,GAAY,UAACO,SAAD,EAAe;AACzB,4BAAI,CAACA,SAAD,IAAc,OAAOA,SAAP,KAAqB,QAAvC,EAAiD;AAC/C,iCAAOD,QAAP;AACD;AACD,+BAAOV,OAAOW,SAAP,KAAqB,IAA5B;AACD,uBALD;AAMAhB,0BAAIK,MAAJ,GAAaA,MAAb;;AACIY,0BAdO,GAcA,SAAPA,IAAO,CAASR,KAAT,EAAgBO,SAAhB,EAA2BE,MAA3B,EAAmC;AAC5C,4BAAIC,YAAJ;AACA,4BAAIH,aAAa,OAAOA,SAAP,KAAqB,SAAtC,EAAiD;AAC/CG,gCAAMnB,IAAIK,MAAJ,CAAWW,SAAX,CAAN;AACD,yBAFD,MAEO;AACLG,gCAAMJ,QAAN;AACAG,mCAASF,SAAT;AACD;AACD,4BAAIE,MAAJ,EAAY;AACV,iCAAO,CAACpB,MAAMsB,2BAAN,CAAkCD,GAAlC,EAAuCV,KAAvC,CAAR;AACD,yBAFD,MAEO;AACL,iCAAOX,MAAMsB,2BAAN,CAAkCD,GAAlC,EAAuCV,KAAvC,KAAiD,CAAxD;AACD;AACF,uBA3BU;;AA4BXX,4BAAMY,sBAAN,CAA6BW,OAA7B,CAAqC,UAACF,GAAD,EAAS;AAC5C,4BAAIG,QAAQH,IAAII,WAAJ,EAAZ;AACAD,gCAAQA,MAAME,MAAN,CAAa,CAAb,EAAgBC,WAAhB,KAAgCH,MAAMI,KAAN,CAAY,CAAZ,CAAxC;AACA1B,mCAASsB,KAAT,IAAoBL,KAAKU,IAAL,CAAU3B,GAAV,EAAemB,GAAf,CAApB;AACD,uBAJD;AAKAjB;;AAjCW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAmCX,6BAAO0B,KAAP,CAAa,aAAIC,KAAJ,gBAAb;AACA3B;;AApCW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G","file":"registered-user.js","sourcesContent":["import _ from 'underscore';\n\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport * as UsersModel from '../models/users';\n\nexport default async function(req, res, next) {\n  try {\n    let levels = await UsersModel.getRegisteredUserLevels(req.hashpass);\n    let maxLevelIndex = _(levels).toArray().map((level) => {\n      return Tools.REGISTERED_USER_LEVELS.indexOf(level);\n    }).sort((level1, level2) => { return level2 - level1; })[0];\n    let maxLevel = Tools.REGISTERED_USER_LEVELS[maxLevelIndex] || null;\n    req.level = (boardName) => {\n      if (!boardName || typeof boardName !== 'string') {\n        return maxLevel;\n      }\n      return levels[boardName] || null;\n    };\n    req.levels = levels;\n    let test = function(level, boardName, strict) {\n      let lvl;\n      if (boardName && typeof boardName !== 'boolean') {\n        lvl = req.levels[boardName];\n      } else {\n        lvl = maxLevel;\n        strict = boardName;\n      }\n      if (strict) {\n        return !Tools.compareRegisteredUserLevels(lvl, level);\n      } else {\n        return Tools.compareRegisteredUserLevels(lvl, level) >= 0;\n      }\n    };\n    Tools.REGISTERED_USER_LEVELS.forEach((lvl) => {\n      let Level = lvl.toLowerCase();\n      Level = Level.charAt(0).toUpperCase() + Level.slice(1)\n      req[`is${Level}`] = test.bind(req, lvl);\n    });\n    next();\n  } catch (err) {\n    Logger.error(err.stack || err);\n    next();\n  }\n}\n"]}