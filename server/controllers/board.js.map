{"version":3,"sources":["controllers/board.js"],"names":["thread","prerendered","board","boardName","Error","Tools","translate","model","title","number","isThreadPage","MiscModel","threadNumber","data","Renderer","render","Cache","writeFile","renderThreadHTML","BoardsModel","getThread","renderThread","JSON","stringify","pageNumber","allowPrerender","getPage","page","series","threads","pageID","readFile","pageJSON","parse","pageHTML","mustRender","some","lastPosts","map","posts","concat","opPost","splice","flatten","reduce","acc","post","pick","_1","postNumber","hasOwnProperty","postsToRerender","pickPostsToRerender","isEmpty","mapObject","getPrerenderedPost","name","renderPage","getPageCount","pageCount","range","renderPages","Files","PostsModel","ThreadsModel","mkpath","RSS_DATE_TIME_FORMAT","client","router","Router","oldPosts","oldPost","options","bannedFor","sequenceNumber","updatedAt","text","oldRefs","referringPosts","ref","newRefs","oldFileInfos","fileInfos","fileInfo","fileName","extraData","newFileInfos","html","startIndex","indexOf","endPattern","endIndex","lastIndexOf","substring","length","paths","description","path","boardNames","getThreadNumbers","threadNumbers","archived","archivedThreadNumbers","sort","arrays","key","isArray","mustCreate","d","action","mustDelete","threadID","threadData","threadHTML","renderPostFileInfos","renderPost","renderedPost","toArray","setThreadDeleted","removeFile","renderCatalog","sortMode","getCatalog","catalog","suffix","renderArchive","getArchive","archive","renderRSS","bind","rssPostCount","collection","Post","find","subject","createdAt","limit","p1","p2","forEach","split","postSubject","t","slice","rss","date","now","ttl","formattedDate","utc","locale","format","match","installThreadHandler","type","get","req","res","next","params","option","test","testPostNumber","create404Error","baseUrl","getThreadRedirect","redirect"],"mappings":";;;;;;;uDAiEA,iBAAgCA,MAAhC;AAAA,oFAA0D,EAA1D;AAAA,QAA0CC,WAA1C,SAA0CA,WAA1C;;AAAA;AAAA;AAAA;AAAA;AAAA;AACMC,iBADN,GACc,gBAAMA,KAAN,CAAYF,OAAOG,SAAnB,CADd;;AAAA,gBAEOD,KAFP;AAAA;AAAA;AAAA;;AAAA,kBAGU,IAAIE,KAAJ,CAAUC,MAAMC,SAAN,CAAgB,eAAhB,CAAV,CAHV;;AAAA;AAKMC,iBALN,GAKc;AACVP,sBAAQA,MADE;AAEVQ,qBAAOR,OAAOQ,KAAP,IAAmBN,MAAMM,KAAzB,gBAAoCR,OAAOS,MAFxC;AAGVC,4BAAc,IAHJ;AAIVR,qBAAOS,UAAUT,KAAV,CAAgBA,KAAhB,EAAuBA,KAJpB;AAKVU,4BAAcZ,OAAOS,MALX;AAMVR,2BAAaA;AANH,aALd;AAaMY,gBAbN,GAaaC,SAASC,MAAT,CAAgB,cAAhB,EAAgCR,KAAhC,CAbb;AAAA;AAAA,mBAcQS,MAAMC,SAAN,CAAmBjB,OAAOG,SAA1B,aAA2CH,OAAOS,MAAlD,YAAiEI,IAAjE,CAdR;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;kBAAeK,gB;;;;;;wDAiBf,kBAA4Bf,SAA5B,EAAuCS,YAAvC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBACqBO,YAAYC,SAAZ,CAAsBjB,SAAtB,EAAiCS,YAAjC,CADrB;;AAAA;AACMZ,kBADN;AAAA;AAAA,mBAEQc,SAASO,YAAT,CAAsBrB,MAAtB,CAFR;;AAAA;AAAA;AAAA,mBAGQgB,MAAMC,SAAN,CAAmBd,SAAnB,aAAoCS,YAApC,YAAyDU,KAAKC,SAAL,CAAe,EAAEvB,QAAQA,MAAV,EAAf,CAAzD,CAHR;;AAAA;AAAA;AAAA,mBAIQkB,iBAAiBlB,MAAjB,CAJR;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;kBAAeqB,Y;;;;;;wDAoBf,kBAA0BlB,SAA1B,EAAqCqB,UAArC;AAAA,oFAAsE,EAAtE;AAAA,QAAmDC,cAAnD,SAAmDA,cAAnD;;AAAA;AAAA;AAAA;AAAA;AAAA;AACMvB,iBADN,GACc,gBAAMA,KAAN,CAAYC,SAAZ,CADd;;AAAA,gBAEOD,KAFP;AAAA;AAAA;AAAA;;AAAA,kBAGU,IAAIE,KAAJ,CAAUC,MAAMC,SAAN,CAAgB,eAAhB,CAAV,CAHV;;AAAA;AAAA;AAAA,mBAKmBa,YAAYO,OAAZ,CAAoBvB,SAApB,EAA+BqB,UAA/B,CALnB;;AAAA;AAKMG,gBALN;AAAA;AAAA,mBAMQtB,MAAMuB,MAAN,CAAaD,KAAKE,OAAlB;AAAA,oEAA2B,kBAAe7B,MAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAClBc,SAASO,YAAT,CAAsBrB,MAAtB,CADkB;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAA3B;;AAAA;AAAA;AAAA;AAAA,gBANR;;AAAA;AASM8B,kBATN,GASgBN,aAAa,CAAd,GAAmBA,UAAnB,GAAgC,OAT/C;;AAAA,iBAUMC,cAVN;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAWyBT,MAAMe,QAAN,CAAkB5B,SAAlB,SAA+BqB,UAA/B,WAXzB;;AAAA;AAWQQ,oBAXR;;AAYIA,uBAAWV,KAAKW,KAAL,CAAWD,QAAX,CAAX;AAZJ;AAAA,mBAayBhB,MAAMe,QAAN,CAAkB5B,SAAlB,SAA+B2B,MAA/B,WAbzB;;AAAA;AAaQI,oBAbR;AAcQC,sBAdR,GAcqBR,KAAKE,OAAL,CAAaO,IAAb,CAAkB,UAACpC,MAAD,EAAY;AAAE,qBAAQyB,mBAAmBzB,OAAOS,MAAlC;AAA4C,aAA5E,CAdrB;AAeQ4B,qBAfR,GAeoBL,SAASH,OAAT,CAAiBS,GAAjB,CAAqB,UAACtC,MAAD,EAAY;AAC/C,kBAAIuC,QAAQvC,OAAOqC,SAAP,CAAiBG,MAAjB,CAAwBxC,OAAOyC,MAA/B,CAAZ;AACA,kBAAIhB,mBAAmBzB,OAAOS,MAA9B,EAAsC;AACpC8B,sBAAMG,MAAN,CAAa,CAAC,CAAd,EAAiB,CAAjB;AACD;AACD,qBAAOH,KAAP;AACD,aANe,CAfpB;;AAsBIF,wBAAY,0BAAEA,SAAF,EAAaM,OAAb,GAAuBC,MAAvB,CAA8B,UAACC,GAAD,EAAMC,IAAN,EAAe;AACvDD,kBAAIC,KAAKrC,MAAT,IAAmBqC,IAAnB;AACA,qBAAOD,GAAP;AACD,aAHW,EAGT,EAHS,CAAZ;AAIIN,iBA1BR,GA0BgBZ,KAAKE,OAAL,CAAaS,GAAb,CAAiB,UAACtC,MAAD,EAAY;AACvC,kBAAIuC,QAAQvC,OAAOqC,SAAP,CAAiBG,MAAjB,CAAwBxC,OAAOyC,MAA/B,CAAZ;AACA,kBAAIhB,mBAAmBzB,OAAOS,MAA9B,EAAsC;AACpC8B,sBAAMG,MAAN,CAAa,CAAC,CAAd,EAAiB,CAAjB;AACD;AACD,qBAAOH,KAAP;AACD,aANW,CA1BhB;;AAiCIA,oBAAQ,0BAAEA,KAAF,EAASI,OAAT,GAAmBC,MAAnB,CAA0B,UAACC,GAAD,EAAMC,IAAN,EAAe;AAC/CD,kBAAIC,KAAKrC,MAAT,IAAmBqC,IAAnB;AACA,qBAAOD,GAAP;AACD,aAHO,EAGL,EAHK,CAAR;AAIAR,wBAAY,0BAAEA,SAAF,EAAaU,IAAb,CAAkB,UAACC,EAAD,EAAKC,UAAL;AAAA,qBAAoBV,MAAMW,cAAN,CAAqBD,UAArB,CAApB;AAAA,aAAlB,CAAZ;AACIE,2BAtCR,GAsC0BC,oBAAoBf,SAApB,EAA+BE,KAA/B,CAtC1B;;AAAA,kBAuCQ,CAACJ,UAAD,IAAe,0BAAEgB,eAAF,EAAmBE,OAAnB,EAvCvB;AAAA;AAAA;AAAA;;AAAA;;AAAA;AA0CQpD,uBA1CR,GA0CsB,0BAAEoC,SAAF,EAAaU,IAAb,CAAkB,UAACC,EAAD,EAAKC,UAAL;AAAA,qBAAoB,CAACE,gBAAgBD,cAAhB,CAA+BD,UAA/B,CAArB;AAAA,aAAlB,CA1CtB;;AA2CIhD,0BAAc,0BAAEA,WAAF,EAAeqD,SAAf,CAAyB,UAACN,EAAD,EAAKC,UAAL,EAAoB;AACzD,qBAAOM,mBAAmBrB,QAAnB,EAA6Be,UAA7B,CAAP;AACD,aAFa,CAAd;AA3CJ;AAAA,mBA8CUjC,MAAMC,SAAN,CAAmBd,SAAnB,SAAgCqB,UAAhC,YAAmDF,KAAKC,SAAL,CAAeI,IAAf,CAAnD,CA9CV;;AAAA;AA+CIA,iBAAK1B,WAAL,GAAmBA,WAAnB;AA/CJ;AAAA;;AAAA;AAAA;AAAA,mBAiDUe,MAAMC,SAAN,CAAmBd,SAAnB,SAAgCqB,UAAhC,YAAmDF,KAAKC,SAAL,CAAeI,IAAf,CAAnD,CAjDV;;AAAA;AAmDEA,iBAAKnB,KAAL,SAAgBN,MAAMsD,IAAtB,kBAAuCtD,MAAMM,KAA7C;AACAmB,iBAAKzB,KAAL,GAAaS,UAAUT,KAAV,CAAgBA,KAAhB,EAAuBA,KAApC;AApDF;AAAA,mBAqDQc,MAAMC,SAAN,CAAmBd,SAAnB,SAAgC2B,MAAhC,YAA+ChB,SAASC,MAAT,CAAgB,aAAhB,EAA+BY,IAA/B,CAA/C,CArDR;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;kBAAe8B,U;;;;;;wDAwDf,kBAA2BtD,SAA3B;AAAA,oFAA2D,EAA3D;AAAA,QAAwCsB,cAAxC,SAAwCA,cAAxC;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBACwBN,YAAYuC,YAAZ,CAAyBvD,SAAzB,CADxB;;AAAA;AACMwD,qBADN;AAAA;AAAA,mBAEetD,MAAMuB,MAAN,CAAa,qBAAEgC,KAAF,CAAQD,SAAR,CAAb;AAAA,oEAAiC,kBAAenC,UAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAC/BiC,WAAWtD,SAAX,EAAsBqB,UAAtB,EAAkC,EAAEC,8BAAF,EAAlC,CAD+B;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAAjC;;AAAA;AAAA;AAAA;AAAA,gBAFf;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;kBAAeoC,W;;;;;AA9Jf;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AACA;;IAAYC,K;;AACZ;;IAAYhD,Q;;AACZ;;IAAYE,K;;AACZ;;;;AACA;;;;AACA;;IAAYX,K;;AACZ;;IAAYc,W;;AACZ;;IAAYR,S;;AACZ;;IAAYoD,U;;AACZ;;IAAYC,Y;;AACZ;;;;;;;;;;AAEA,IAAMC,SAAS,6BAAU,QAAV,CAAf;;AAEA,IAAMC,uBAAuB,iCAA7B;;AAEA,IAAIC,SAAS,qCAAb;AACA,IAAIC,SAAS,kBAAQC,MAAR,EAAb;;AAEA,SAASjB,mBAAT,CAA6BkB,QAA7B,EAAuC/B,KAAvC,EAA8C;AAC5C,SAAO,0BAAEA,KAAF,EAASQ,IAAT,CAAc,UAACD,IAAD,EAAOG,UAAP,EAAsB;AACzC,QAAIsB,UAAUD,SAASrB,UAAT,CAAd;AACA,QAAI,CAACsB,OAAL,EAAc;AACZ,aAAO,IAAP;AACD;AACD,QAAIA,QAAQC,OAAR,CAAgBC,SAAhB,KAA8B3B,KAAK0B,OAAL,CAAaC,SAA/C,EAA0D;AACxD,aAAO,IAAP;AACD;AACD,QAAIF,QAAQG,cAAR,KAA2B5B,KAAK4B,cAApC,EAAoD;AAClD,aAAO,IAAP;AACD;AACD,QAAIH,QAAQI,SAAR,GAAoB7B,KAAK6B,SAA7B,EAAwC;AACtC,aAAO,IAAP;AACD;AACD,QAAIJ,QAAQK,IAAR,KAAiB9B,KAAK8B,IAA1B,EAAgC;AAC9B,aAAO,IAAP;AACD;AACD,QAAIC,UAAUN,QAAQO,cAAR,CAAuBlC,MAAvB,CAA8B,UAACC,GAAD,EAAMkC,GAAN,EAAc;AACxD,aAAUlC,GAAV,SAAiBkC,IAAI5E,SAArB,SAAkC4E,IAAI9B,UAAtC;AACD,KAFa,EAEX,EAFW,CAAd;AAGA,QAAI+B,UAAUlC,KAAKgC,cAAL,CAAoBlC,MAApB,CAA2B,UAACC,GAAD,EAAMkC,GAAN,EAAc;AACrD,aAAUlC,GAAV,SAAiBkC,IAAI5E,SAArB,SAAkC4E,IAAI9B,UAAtC;AACD,KAFa,EAEX,EAFW,CAAd;AAGA,QAAI4B,YAAYG,OAAhB,EAAyB;AACvB,aAAO,IAAP;AACD;AACD,QAAIC,eAAeV,QAAQW,SAAR,CAAkBtC,MAAlB,CAAyB,UAACC,GAAD,EAAMsC,QAAN,EAAmB;AAC7D,aAAUtC,GAAV,SAAiBsC,SAASC,QAA1B,SAAsC9D,KAAKC,SAAL,CAAe4D,SAASE,SAAxB,CAAtC;AACD,KAFkB,EAEhB,EAFgB,CAAnB;AAGA,QAAIC,eAAexC,KAAKoC,SAAL,CAAetC,MAAf,CAAsB,UAACC,GAAD,EAAMsC,QAAN,EAAmB;AAC1D,aAAUtC,GAAV,SAAiBsC,SAASC,QAA1B,SAAsC9D,KAAKC,SAAL,CAAe4D,SAASE,SAAxB,CAAtC;AACD,KAFkB,EAEhB,EAFgB,CAAnB;AAGA,QAAIJ,iBAAiBK,YAArB,EAAmC;AACjC,aAAO,IAAP;AACD;AACF,GAnCM,CAAP;AAoCD;;AA0BD,SAAS/B,kBAAT,CAA4BgC,IAA5B,EAAkCtC,UAAlC,EAA8C;AAC5C,MAAIuC,aAAaD,KAAKE,OAAL,qBAA8BxC,UAA9B,QAAjB;AACA,MAAIuC,aAAa,CAAjB,EAAoB;AAClB;AACD;AACD,MAAIE,yCAAuCzC,UAAvC,QAAJ;AACA,MAAI0C,WAAWJ,KAAKK,WAAL,CAAiBF,UAAjB,CAAf;AACA,MAAIC,WAAW,CAAf,EAAkB;AAChB;AACD;AACD,SAAOJ,KAAKM,SAAL,CAAeL,UAAf,EAA2BG,WAAWD,WAAWI,MAAjD,CAAP;AACD;;AA+DA;;AAED1B,OAAO2B,KAAP;AAAA,yDAAe,kBAAeC,WAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBACTA,WADS;AAAA;AAAA;AAAA;;AAAA,8CAEJ,CAAC;AACNC,oBAAM,eADA;AAEND,2BAAa3F,MAAMC,SAAN,CAAgB,2BAAhB;AAFP,aAAD,EAGJ;AACD2F,oBAAM,uBADL;AAEDD,2BAAa3F,MAAMC,SAAN,CAAgB,mDAAhB;AAFZ,aAHI,EAMJ;AACD2F,oBAAM,uBADL;AAEDD,2BAAa3F,MAAMC,SAAN,CAAgB,oBAAhB;AAFZ,aANI,EASJ;AACD2F,oBAAM,mBADL;AAEDD,2BAAa3F,MAAMC,SAAN,CAAgB,gBAAhB;AAFZ,aATI,EAYJ;AACD2F,oBAAM,mCADL;AAEDD,2BAAa3F,MAAMC,SAAN,CAAgB,UAAhB;AAFZ,aAZI,CAFI;;AAAA;AAAA;AAAA,mBAmBMD,MAAMuB,MAAN,CAAa,gBAAMsE,UAAN,EAAb;AAAA,qEAAiC,kBAAe/F,SAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BACxB6D,aAAamC,gBAAb,CAA8BhG,SAA9B,CADwB;;AAAA;AAC9CiG,qCAD8C;AAAA;AAAA,+BAEhBpC,aAAamC,gBAAb,CAA8BhG,SAA9B,EAAyC,EAAEkG,UAAU,IAAZ,EAAzC,CAFgB;;AAAA;AAE9CC,6CAF8C;;AAGlDF,wCAAgBA,cAAc5D,MAAd,CAAqB8D,qBAArB,EAA4CC,IAA5C,EAAhB;AACIR,6BAJ8C,GAItC,OAAK5F,SAAL,QAAsBA,SAAtB,qBAA+CA,SAA/C,qBAAwEA,SAAxE,UAJsC;AAAA,0DAK3C4F,MAAMvD,MAAN,CAAa4D,cAAc9D,GAAd,CAAkB;AAAA,uCAAoBnC,SAApB,aAAqCS,YAArC;AAAA,yBAAlB,CAAb,CAL2C;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAAjC;;AAAA;AAAA;AAAA;AAAA,iBAMhB,IANgB,CAnBN;;AAAA;AAmBT4F,kBAnBS;AAAA,8CA0BN,0BAAEA,MAAF,EAAU7D,OAAV,EA1BM;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAf;;AAAA;AAAA;AAAA;AAAA;;AA6BAyB,OAAO/C,YAAP;AAAA,yDAAsB,mBAAeoF,GAAf,EAAoB5F,IAApB;AAAA;AAAA;AAAA;AAAA;AAAA;AACpB,gBAAI,CAAC,0BAAEA,IAAF,EAAQ6F,OAAR,EAAL,EAAwB;AACtB7F,qBAAO,CAACA,IAAD,CAAP;AACD;AACG8F,sBAJgB,GAIH9F,KAAKuB,IAAL,CAAU,UAACwE,CAAD,EAAO;AAAE,qBAAO,aAAaA,EAAEC,MAAtB;AAA+B,aAAlD,CAJG;AAKhBC,sBALgB,GAKHjG,KAAKuB,IAAL,CAAU,UAACwE,CAAD,EAAO;AAAE,qBAAO,aAAaA,EAAEC,MAAtB;AAA+B,aAAlD,CALG;;AAAA,kBAMhBF,cAAcG,UANE;AAAA;AAAA;AAAA;;AAAA;;AAAA;AASpBjG,mBAAOA,KAAK+B,MAAL,CAAY,UAACC,GAAD,EAAM+D,CAAN,EAAY;AAC7B,kBAAI,CAAC/D,GAAL,EAAU;AACR,uBAAO+D,CAAP;AACD;AACD,kBAAIA,EAAEC,MAAF,GAAWhE,IAAIgE,MAAnB,EAA2B;AACzB,uBAAOD,CAAP;AACD;AACD,qBAAO/D,GAAP;AACD,aARM,CAAP;AASI3C,iBAlBgB,GAkBR,gBAAMA,KAAN,CAAYW,KAAKV,SAAjB,CAlBQ;;AAAA,gBAmBfD,KAnBe;AAAA;AAAA;AAAA;;AAAA,kBAoBZ,IAAIE,KAAJ,CAAUC,MAAMC,SAAN,CAAgB,eAAhB,CAAV,CApBY;;AAAA;AAAA,4BAsBZO,KAAKgG,MAtBO;AAAA,gDAuBf,QAvBe,0BA2Bf,MA3Be,0BA6Df,QA7De;AAAA;;AAAA;AAAA;AAAA,mBAwBZxF,aAAaR,KAAKV,SAAlB,EAA6BU,KAAKD,YAAlC,CAxBY;;AAAA;AAAA;;AAAA;AA4BdmG,oBA5Bc,GA4BAlG,KAAKV,SA5BL,aA4BsBU,KAAKD,YA5B3B;AAAA;AAAA,mBA6BKI,MAAMe,QAAN,CAAkBgF,QAAlB,WA7BL;;AAAA;AA6BdC,sBA7Bc;AA8BdzG,iBA9Bc,GA8BNe,KAAKW,KAAL,CAAW+E,UAAX,CA9BM;AA+BdhH,kBA/Bc,GA+BLO,MAAMP,MA/BD;AAgCdqC,qBAhCc,GAgCFrC,OAAOqC,SAAP,CAAiBO,MAAjB,CAAwB,UAACC,GAAD,EAAMC,IAAN,EAAe;AACrDD,kBAAIC,KAAKrC,MAAT,IAAmBqC,IAAnB;AACA,qBAAOD,GAAP;AACD,aAHe,EAGb,EAHa,CAhCE;AAAA;AAAA,mBAoCH1B,YAAYC,SAAZ,CAAsBP,KAAKV,SAA3B,EAAsCU,KAAKD,YAA3C,CApCG;;AAAA;AAoClBZ,kBApCkB;AAqCduC,iBArCc,GAqCNvC,OAAOqC,SAAP,CAAiBO,MAAjB,CAAwB,UAACC,GAAD,EAAMC,IAAN,EAAe;AACjDD,kBAAIC,KAAKrC,MAAT,IAAmBqC,IAAnB;AACA,qBAAOD,GAAP;AACD,aAHW,EAGT,EAHS,CArCM;;AAyClBR,wBAAY,0BAAEA,SAAF,EAAaU,IAAb,CAAkB,UAACC,EAAD,EAAKC,UAAL;AAAA,qBAAoBV,MAAMW,cAAN,CAAqBD,UAArB,CAApB;AAAA,aAAlB,CAAZ;AACIE,2BA1Cc,GA0CIC,oBAAoBf,SAApB,EAA+BE,KAA/B,CA1CJ;AAAA;AAAA,mBA2CKvB,MAAMe,QAAN,CAAkBgF,QAAlB,WA3CL;;AAAA;AA2CdE,sBA3Cc;AA4CdhH,uBA5Cc,GA4CA,0BAAEoC,SAAF,EAAaU,IAAb,CAAkB,UAACC,EAAD,EAAKC,UAAL;AAAA,qBAAoB,CAACE,gBAAgBD,cAAhB,CAA+BD,UAA/B,CAArB;AAAA,aAAlB,CA5CA;;AA6ClBhD,0BAAc,0BAAEA,WAAF,EAAeqD,SAAf,CAAyB,UAACN,EAAD,EAAKC,UAAL,EAAoB;AACzD,qBAAOM,mBAAmB0D,UAAnB,EAA+BhE,UAA/B,CAAP;AACD,aAFa,CAAd;AA7CkB;AAAA,mBAgDZa,MAAMoD,mBAAN,CAA0BlH,OAAOyC,MAAjC,CAhDY;;AAAA;AAAA;AAAA,mBAiDIvC,MAAMiH,UAAN,CAAiBnH,OAAOyC,MAAxB,CAjDJ;;AAAA;AAiDlBzC,mBAAOyC,MAjDW;AAAA;AAAA,mBAkDZpC,MAAMuB,MAAN,CAAauB,eAAb;AAAA,qEAA8B,kBAAeL,IAAf,EAAqBG,UAArB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAC5Ba,MAAMoD,mBAAN,CAA0BpE,IAA1B,CAD4B;;AAAA;AAAA;AAAA,+BAET5C,MAAMiH,UAAN,CAAiBrE,IAAjB,CAFS;;AAAA;AAE9BsE,oCAF8B;;AAGlC/E,kCAAUY,UAAV,IAAwBmE,YAAxB;;AAHkC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAA9B;;AAAA;AAAA;AAAA;AAAA,gBAlDY;;AAAA;AAuDlBpH,mBAAOqC,SAAP,GAAmB,0BAAEA,SAAF,EAAagF,OAAb,EAAnB;AACA9G,kBAAMP,MAAN,GAAeA,MAAf;AAxDkB;AAAA,mBAyDZgB,MAAMC,SAAN,CAAmB8F,QAAnB,YAAoCzF,KAAKC,SAAL,CAAehB,KAAf,CAApC,CAzDY;;AAAA;AAAA;AAAA,mBA0DZW,iBAAiBlB,MAAjB,EAAyB,EAAEC,aAAaA,WAAf,EAAzB,CA1DY;;AAAA;AAAA;;AAAA;AAAA;AAAA,mBA8DZ+D,aAAasD,gBAAb,CAAiCzG,KAAKV,SAAtC,SAAmDU,KAAKD,YAAxD,CA9DY;;AAAA;AAAA;AAAA,mBA+DZI,MAAMuG,UAAN,CAAoB1G,KAAKV,SAAzB,aAA0CU,KAAKD,YAA/C,WA/DY;;AAAA;AAAA;AAAA,mBAgEZI,MAAMuG,UAAN,CAAoB1G,KAAKV,SAAzB,aAA0CU,KAAKD,YAA/C,WAhEY;;AAAA;AAAA;;AAAA;AAAA,kBAoEZ,IAAIR,KAAJ,CAAUC,MAAMC,SAAN,CAAgB,gBAAhB,CAAV,CApEY;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAtB;;AAAA;AAAA;AAAA;AAAA;;AAyEA8D,OAAOP,WAAP;AAAA,yDAAqB,mBAAe1D,SAAf,EAA0BS,YAA1B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBACNiD,YAAY1D,SAAZ,EAAuB,EAAEsB,gBAAgBb,gBAAgB,IAAlC,EAAvB,CADM;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAArB;;AAAA;AAAA;AAAA;AAAA;;AAIAwD,OAAOoD,aAAP;AAAA,yDAAuB,mBAAerH,SAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AACjBD,iBADiB,GACT,gBAAMA,KAAN,CAAYC,SAAZ,CADS;;AAAA,gBAEhBD,KAFgB;AAAA;AAAA;AAAA;;AAAA,kBAGb,IAAIE,KAAJ,CAAUC,MAAMC,SAAN,CAAgB,eAAhB,CAAV,CAHa;;AAAA;AAAA;AAAA,mBAKfD,MAAMuB,MAAN,CAAa,CAAC,MAAD,EAAS,QAAT,EAAmB,OAAnB,CAAb;AAAA,qEAA0C,mBAAe6F,QAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAC1BtG,YAAYuG,UAAZ,CAAuBvH,SAAvB,EAAkCsH,QAAlC,CAD0B;;AAAA;AAC1CE,+BAD0C;AAAA;AAAA,+BAExCtH,MAAMuB,MAAN,CAAa+F,QAAQ9F,OAArB;AAAA,iFAA8B,mBAAe7B,MAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2CACrBc,SAASO,YAAT,CAAsBrB,MAAtB,CADqB;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2BAA9B;;AAAA;AAAA;AAAA;AAAA,4BAFwC;;AAAA;AAK1C4H,8BAL0C,GAKhC,WAAWH,QAAZ,SAA4BA,QAA5B,GAAyC,EALR;AAAA;AAAA,+BAMxCzG,MAAMC,SAAN,CAAmBd,SAAnB,gBAAuCyH,MAAvC,YAAsDtG,KAAKC,SAAL,CAAeoG,OAAf,CAAtD,CANwC;;AAAA;AAO9CA,gCAAQnH,KAAR,GAAgBN,MAAMM,KAAtB;AACAmH,gCAAQzH,KAAR,GAAgBS,UAAUT,KAAV,CAAgBA,KAAhB,EAAuBA,KAAvC;AACAyH,gCAAQF,QAAR,GAAmBA,QAAnB;AAT8C,2DAUvCzG,MAAMC,SAAN,CAAmBd,SAAnB,gBAAuCyH,MAAvC,YAAsD9G,SAASC,MAAT,CAAgB,eAAhB,EAAiC4G,OAAjC,CAAtD,CAVuC;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAA1C;;AAAA;AAAA;AAAA;AAAA,gBALe;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAvB;;AAAA;AAAA;AAAA;AAAA;;AAmBAvD,OAAOyD,aAAP;AAAA,yDAAuB,mBAAe1H,SAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AACjBD,iBADiB,GACT,gBAAMA,KAAN,CAAYC,SAAZ,CADS;;AAAA,gBAEhBD,KAFgB;AAAA;AAAA;AAAA;;AAAA,kBAGb,IAAIE,KAAJ,CAAUC,MAAMC,SAAN,CAAgB,eAAhB,CAAV,CAHa;;AAAA;AAAA;AAAA,mBAKDa,YAAY2G,UAAZ,CAAuB3H,SAAvB,CALC;;AAAA;AAKjB4H,mBALiB;AAAA;AAAA,mBAMf/G,MAAMC,SAAN,CAAmBd,SAAnB,oBAA6CmB,KAAKC,SAAL,CAAewG,OAAf,CAA7C,CANe;;AAAA;AAOrBA,oBAAQvH,KAAR,GAAgBN,MAAMM,KAAtB;AACAuH,oBAAQ7H,KAAR,GAAgBS,UAAUT,KAAV,CAAgBA,KAAhB,EAAuBA,KAAvC;AARqB;AAAA,mBASfc,MAAMC,SAAN,CAAmBd,SAAnB,oBAA6CW,SAASC,MAAT,CAAgB,eAAhB,EAAiCgH,OAAjC,CAA7C,CATe;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAvB;;AAAA;AAAA;AAAA;AAAA;;AAYA3D,OAAO4D,SAAP;AAAA,yDAAmB,mBAAe7H,SAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBACZA,SADY;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAEFE,MAAMuB,MAAN,CAAa,gBAAMsE,UAAN,EAAb,EAAiC9B,OAAO4D,SAAP,CAAiBC,IAAjB,CAAsB7D,MAAtB,CAAjC,CAFE;;AAAA;AAAA;;AAAA;AAIblE,iBAJa,GAIL,gBAAMA,KAAN,CAAYC,SAAZ,CAJK;;AAAA,gBAKZD,KALY;AAAA;AAAA;AAAA;;AAAA,kBAMT,IAAIE,KAAJ,CAAUC,MAAMC,SAAN,CAAgB,0BAAhB,EAA4C,EAA5C,EAAgDH,SAAhD,CAAV,CANS;;AAAA;AAQb+H,wBARa,GAQE,sBAAO,sBAAP,CARF;AAAA;AAAA,mBASA/D,OAAOgE,UAAP,CAAkB,MAAlB,CATA;;AAAA;AASbC,gBATa;AAAA;AAAA,mBAUCA,KAAKC,IAAL,CAAU,EAAElI,WAAWA,SAAb,EAAV,EAAoC;AACpDM,sBAAQ,CAD4C;AAEpDG,4BAAc,CAFsC;AAGpD0H,uBAAS,CAH2C;AAIpD9E,oBAAM,CAJ8C;AAKpDoB,oBAAM,CAL8C;AAMpDM,yBAAW,CANyC;AAOpDqD,yBAAW;AAPyC,aAApC,EAQfhC,IARe,CAQV,EAAEgC,WAAW,CAAC,CAAd,EARU,EAQSC,KART,CAQeN,YARf,EAQ6Bb,OAR7B,EAVD;;AAAA;AAUb9E,iBAVa;;AAAA,kBAmBbA,MAAMuD,MAAN,IAAgB,CAnBH;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAsBjBvD,kBAAMgE,IAAN,CAAW,UAACkC,EAAD,EAAKC,EAAL,EAAY;AACrB,qBAAO,CAACD,GAAGF,SAAJ,GAAgB,CAACG,GAAGH,SAA3B;AACD,aAFD;AAGAhG,kBAAMoG,OAAN,CAAc,UAAC7F,IAAD,EAAU;AACtB,kBAAIA,KAAK8B,IAAT,EAAe;AACb9B,qBAAK8B,IAAL,GAAY9B,KAAK8B,IAAL,CAAUgE,KAAV,CAAgB,OAAhB,EAAyB,GAAzB,CAAZ,CADa,CAC8B;AAC5C;AACD9F,mBAAKwF,OAAL,GAAenH,YAAY0H,WAAZ,CAAwB/F,IAAxB,EAA8B,GAA9B,KAAsCA,KAAKrC,MAA1D,CAJsB,CAI4C;AAClE,kBAAIqI,IAAKhG,KAAKU,IAAL,IAAcV,KAAKU,IAAL,CAAUiC,OAAV,CAAkB,MAAlB,MAA8B,CAAC,CAA9C,GAAoD3C,KAAKU,IAAL,CAAUiC,OAAV,CAAkB,GAAlB,CAApD,GAA6E,CAAC,CAAtF;AACA,kBAAIqD,IAAI,CAAR,EAAW;AACPhG,qBAAKU,IAAL,GAAYV,KAAKU,IAAL,CAAUuF,KAAV,CAAgB,CAAhB,EAAmBD,CAAnB,CAAZ;AACH,eAFD,MAEO,IAAIA,KAAK,CAAT,EACH,OAAOhG,KAAKU,IAAZ;AACL,aAVD;AAWIwF,eApCa,GAoCP;AACRC,oBAAM5I,MAAM6I,GAAN,EADE;AAERC,mBAAK,sBAAO,gBAAP,CAFG;AAGRjJ,qBAAOS,UAAUT,KAAV,CAAgBA,KAAhB,EAAuBA,KAHtB;AAIRqC,qBAAOA,KAJC;AAKR6G,6BAAe,uBAACH,IAAD,EAAU;AACvB,uBAAO,sBAAOA,IAAP,EAAaI,GAAb,GAAmBC,MAAnB,CAA0B,IAA1B,EAAgCC,MAAhC,CAAuCrF,oBAAvC,CAAP;AACD;AAPO,aApCO;AAAA;AAAA,mBA6CJlD,MAAMC,SAAN,CAAmBd,SAAnB,eAAwCW,SAASC,MAAT,CAAgB,WAAhB,EAA6BiI,GAA7B,CAAxC,CA7CI;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAnB;;AAAA;AAAA;AAAA;AAAA;;AAgDA5E,OAAOrD,MAAP;AAAA,yDAAgB,mBAAekF,IAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AACVuD,iBADU,GACFvD,KAAKuD,KAAL,CAAW,mBAAX,CADE;;AAAA,iBAEVA,KAFU;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAGCpF,OAAO4D,SAAP,CAAiBwB,MAAM,CAAN,CAAjB,CAHD;;AAAA;AAAA;;AAAA;AAKdA,oBAAQvD,KAAKuD,KAAL,CAAW,cAAX,CAAR;;AALc,iBAMVA,KANU;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAOC3F,YAAY2F,MAAM,CAAN,CAAZ,CAPD;;AAAA;AAAA;;AAAA;AASdA,oBAAQvD,KAAKuD,KAAL,CAAW,uBAAX,CAAR;;AATc,iBAUVA,KAVU;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAWCpF,OAAOyD,aAAP,CAAqB2B,MAAM,CAAN,CAArB,CAXD;;AAAA;AAAA;;AAAA;AAadA,oBAAQvD,KAAKuD,KAAL,CAAW,uBAAX,CAAR;;AAbc,iBAcVA,KAdU;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAeCpF,OAAOoD,aAAP,CAAqBgC,MAAM,CAAN,CAArB,CAfD;;AAAA;AAAA;;AAAA;AAiBdA,oBAAQvD,KAAKuD,KAAL,CAAW,0BAAX,CAAR;;AAjBc,iBAkBVA,KAlBU;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAmBCnI,aAAamI,MAAM,CAAN,CAAb,EAAuB,CAACA,MAAM,CAAN,CAAxB,CAnBD;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAhB;;AAAA;AAAA;AAAA;AAAA;;AAuBApF,OAAOlD,gBAAP,GAA0BA,gBAA1B;;AAEA,SAASuI,oBAAT,CAA8BC,IAA9B,EAAoC;AAClCtF,SAAOuF,GAAP,oCAA4CD,IAA5C;AAAA,2DAAoD,mBAAeE,GAAf,EAAoBC,GAApB,EAAyBC,IAAzB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,4BAChBF,IAAIG,MADY,EAC5C5J,SAD4C,eAC5CA,SAD4C,EACjCS,YADiC,eACjCA,YADiC;;AAElDA,6BAAeP,MAAM2J,MAAN,CAAapJ,YAAb,EAA2B,QAA3B,EAAqC,CAArC,EAAwC,EAAEqJ,MAAM5J,MAAM6J,cAAd,EAAxC,CAAf;;AAFkD,kBAG7CtJ,YAH6C;AAAA;AAAA;AAAA;;AAAA,iDAIzCkJ,KAAKzJ,MAAM8J,cAAN,CAAqBP,IAAIQ,OAAzB,CAAL,CAJyC;;AAAA;AAAA;AAAA,qBAM7BpG,aAAaqG,iBAAb,CAA+BlK,SAA/B,EAA0CS,YAA1C,CAN6B;;AAAA;AAM9C0J,sBAN8C;;AAAA,kBAO7CA,QAP6C;AAAA;AAAA;AAAA;;AAAA,iDAQzCR,KAAKzJ,MAAM8J,cAAN,CAAqBP,IAAIQ,OAAzB,CAAL,CARyC;;AAAA;AAUlDP,kBAAIS,QAAJ,CAAa,GAAb,QAAsB,sBAAO,iBAAP,CAAtB,GAAkDA,SAASnK,SAA3D,aAA4EmK,SAAS1J,YAArF,SAAqG8I,IAArG;;AAVkD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAApD;;AAAA;AAAA;AAAA;AAAA;AAYD;;AAEDD,qBAAqB,MAArB;AACAA,qBAAqB,MAArB;;kBAEerF,M","file":"board.js","sourcesContent":["import _ from 'underscore';\nimport express from 'express';\nimport FS from 'q-io/fs';\nimport moment from 'moment';\nimport promisify from 'promisify-node';\n\nimport Board from '../boards/board';\nimport * as Files from '../core/files';\nimport * as Renderer from '../core/renderer';\nimport * as Cache from '../helpers/cache';\nimport config from '../helpers/config';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport * as BoardsModel from '../models/boards';\nimport * as MiscModel from '../models/misc';\nimport * as PostsModel from '../models/posts';\nimport * as ThreadsModel from '../models/threads';\nimport mongodbClient from '../storage/mongodb-client-factory';\n\nconst mkpath = promisify('mkpath');\n\nconst RSS_DATE_TIME_FORMAT = 'ddd, DD MMM YYYY HH:mm:ss +0000';\n\nlet client = mongodbClient();\nlet router = express.Router();\n\nfunction pickPostsToRerender(oldPosts, posts) {\n  return _(posts).pick((post, postNumber) => {\n    let oldPost = oldPosts[postNumber];\n    if (!oldPost) {\n      return true;\n    }\n    if (oldPost.options.bannedFor !== post.options.bannedFor) {\n      return true;\n    }\n    if (oldPost.sequenceNumber !== post.sequenceNumber) {\n      return true;\n    }\n    if (oldPost.updatedAt < post.updatedAt) {\n      return true;\n    }\n    if (oldPost.text !== post.text) {\n      return true;\n    }\n    let oldRefs = oldPost.referringPosts.reduce((acc, ref) => {\n      return `${acc};${ref.boardName}:${ref.postNumber}`;\n    }, '');\n    let newRefs = post.referringPosts.reduce((acc, ref) => {\n      return `${acc};${ref.boardName}:${ref.postNumber}`;\n    }, '');\n    if (oldRefs !== newRefs) {\n      return true;\n    }\n    let oldFileInfos = oldPost.fileInfos.reduce((acc, fileInfo) => {\n      return `${acc};${fileInfo.fileName}:${JSON.stringify(fileInfo.extraData)}`;\n    }, '');\n    let newFileInfos = post.fileInfos.reduce((acc, fileInfo) => {\n      return `${acc};${fileInfo.fileName}:${JSON.stringify(fileInfo.extraData)}`;\n    }, '');\n    if (oldFileInfos !== newFileInfos) {\n      return true;\n    }\n  });\n}\n\nasync function renderThreadHTML(thread, { prerendered } = {}) {\n  let board = Board.board(thread.boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  let model = {\n    thread: thread,\n    title: thread.title || `${board.title} â€” ${thread.number}`,\n    isThreadPage: true,\n    board: MiscModel.board(board).board,\n    threadNumber: thread.number,\n    prerendered: prerendered\n  };\n  let data = Renderer.render('pages/thread', model);\n  await Cache.writeFile(`${thread.boardName}/res/${thread.number}.html`, data);\n}\n\nasync function renderThread(boardName, threadNumber) {\n  let thread = await BoardsModel.getThread(boardName, threadNumber);\n  await Renderer.renderThread(thread);\n  await Cache.writeFile(`${boardName}/res/${threadNumber}.json`, JSON.stringify({ thread: thread }));\n  await renderThreadHTML(thread);\n}\n\nfunction getPrerenderedPost(html, postNumber) {\n  let startIndex = html.indexOf(`<div id='post-${postNumber}'`);\n  if (startIndex < 0) {\n    return;\n  }\n  let endPattern = `<!--__ololord_end_post#${postNumber}-->`;\n  let endIndex = html.lastIndexOf(endPattern);\n  if (endIndex < 0) {\n    return;\n  }\n  return html.substring(startIndex, endIndex + endPattern.length);\n}\n\nasync function renderPage(boardName, pageNumber, { allowPrerender } = {}) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  let page = await BoardsModel.getPage(boardName, pageNumber);\n  await Tools.series(page.threads, async function(thread) {\n    return await Renderer.renderThread(thread);\n  });\n  let pageID = (pageNumber > 0) ? pageNumber : 'index';\n  if (allowPrerender) {\n    let pageJSON = await Cache.readFile(`${boardName}/${pageNumber}.json`);\n    pageJSON = JSON.parse(pageJSON);\n    let pageHTML = await Cache.readFile(`${boardName}/${pageID}.html`);\n    let mustRender = page.threads.some((thread) => { return (allowPrerender === thread.number); });\n    let lastPosts = pageJSON.threads.map((thread) => {\n      let posts = thread.lastPosts.concat(thread.opPost);\n      if (allowPrerender === thread.number) {\n        posts.splice(-1, 1);\n      }\n      return posts;\n    });\n    lastPosts = _(lastPosts).flatten().reduce((acc, post) => {\n      acc[post.number] = post;\n      return acc;\n    }, {});\n    let posts = page.threads.map((thread) => {\n      let posts = thread.lastPosts.concat(thread.opPost);\n      if (allowPrerender === thread.number) {\n        posts.splice(-1, 1);\n      }\n      return posts;\n    });\n    posts = _(posts).flatten().reduce((acc, post) => {\n      acc[post.number] = post;\n      return acc;\n    }, {});\n    lastPosts = _(lastPosts).pick((_1, postNumber) => posts.hasOwnProperty(postNumber));\n    let postsToRerender = pickPostsToRerender(lastPosts, posts);\n    if (!mustRender && _(postsToRerender).isEmpty()) {\n      return;\n    }\n    let prerendered = _(lastPosts).pick((_1, postNumber) => !postsToRerender.hasOwnProperty(postNumber));\n    prerendered = _(prerendered).mapObject((_1, postNumber) => {\n      return getPrerenderedPost(pageHTML, postNumber);\n    });\n    await Cache.writeFile(`${boardName}/${pageNumber}.json`, JSON.stringify(page));\n    page.prerendered = prerendered;\n  } else {\n    await Cache.writeFile(`${boardName}/${pageNumber}.json`, JSON.stringify(page));\n  }\n  page.title =`/${board.name}/ &mdash; ${board.title}`;\n  page.board = MiscModel.board(board).board;\n  await Cache.writeFile(`${boardName}/${pageID}.html`, Renderer.render('pages/board', page));\n}\n\nasync function renderPages(boardName, { allowPrerender } = {}) {\n  let pageCount = await BoardsModel.getPageCount(boardName);\n  return await Tools.series(_.range(pageCount), async function(pageNumber) {\n    return await renderPage(boardName, pageNumber, { allowPrerender });\n  });\n};\n\nrouter.paths = async function(description) {\n  if (description) {\n    return [{\n      path: '/<board name>',\n      description: Tools.translate('Board pages (from 0 to N)')\n    }, {\n      path: '/<board name>/archive',\n      description: Tools.translate('Board archive page (WITHOUT the archived threads)')\n    }, {\n      path: '/<board name>/catalog',\n      description: Tools.translate('Board catalog page')\n    }, {\n      path: '/<board name>/rss',\n      description: Tools.translate('Board RSS feed')\n    }, {\n      path: '/<board name>/res/<thread number>',\n      description: Tools.translate('A thread')\n    }];\n  }\n  let arrays = await Tools.series(Board.boardNames(), async function(boardName) {\n    let threadNumbers = await ThreadsModel.getThreadNumbers(boardName);\n    let archivedThreadNumbers = await ThreadsModel.getThreadNumbers(boardName, { archived: true });\n    threadNumbers = threadNumbers.concat(archivedThreadNumbers).sort();\n    let paths = [`/${boardName}`, `/${boardName}/archive`, `/${boardName}/catalog`, `/${boardName}/rss`];\n    return paths.concat(threadNumbers.map(threadNumber => `/${boardName}/res/${threadNumber}`));\n  }, true);\n  return _(arrays).flatten();\n};\n\nrouter.renderThread = async function(key, data) {\n  if (!_(data).isArray()) {\n    data = [data];\n  }\n  let mustCreate = data.some((d) => { return 'create' === d.action; });\n  let mustDelete = data.some((d) => { return 'delete' === d.action; });\n  if (mustCreate && mustDelete) {\n    return; //NOTE: This should actually never happen\n  }\n  data = data.reduce((acc, d) => {\n    if (!acc) {\n      return d;\n    }\n    if (d.action < acc.action) {\n      return d;\n    }\n    return acc;\n  });\n  let board = Board.board(data.boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  switch (data.action) {\n  case 'create': {\n    await renderThread(data.boardName, data.threadNumber);\n    break;\n  }\n  case 'edit': {\n    let threadID = `${data.boardName}/res/${data.threadNumber}`;\n    let threadData = await Cache.readFile(`${threadID}.json`);\n    let model = JSON.parse(threadData);\n    let thread = model.thread;\n    let lastPosts = thread.lastPosts.reduce((acc, post) => {\n      acc[post.number] = post;\n      return acc;\n    }, {});\n    thread = await BoardsModel.getThread(data.boardName, data.threadNumber);\n    let posts = thread.lastPosts.reduce((acc, post) => {\n      acc[post.number] = post;\n      return acc;\n    }, {});\n    lastPosts = _(lastPosts).pick((_1, postNumber) => posts.hasOwnProperty(postNumber));\n    let postsToRerender = pickPostsToRerender(lastPosts, posts);\n    let threadHTML = await Cache.readFile(`${threadID}.html`);\n    let prerendered = _(lastPosts).pick((_1, postNumber) => !postsToRerender.hasOwnProperty(postNumber));\n    prerendered = _(prerendered).mapObject((_1, postNumber) => {\n      return getPrerenderedPost(threadHTML, postNumber);\n    });\n    await Files.renderPostFileInfos(thread.opPost);\n    thread.opPost = await board.renderPost(thread.opPost);\n    await Tools.series(postsToRerender, async function(post, postNumber) {\n      await Files.renderPostFileInfos(post);\n      let renderedPost = await board.renderPost(post);\n      lastPosts[postNumber] = renderedPost;\n    });\n    thread.lastPosts = _(lastPosts).toArray();\n    model.thread = thread;\n    await Cache.writeFile(`${threadID}.json`, JSON.stringify(model));\n    await renderThreadHTML(thread, { prerendered: prerendered });\n    break;\n  }\n  case 'delete': {\n    await ThreadsModel.setThreadDeleted(`${data.boardName}:${data.threadNumber}`);\n    await Cache.removeFile(`${data.boardName}/res/${data.threadNumber}.json`);\n    await Cache.removeFile(`${data.boardName}/res/${data.threadNumber}.html`);\n    break;\n  }\n  default: {\n    throw new Error(Tools.translate('Invalid action'));\n  }\n  }\n}\n\nrouter.renderPages = async function(boardName, threadNumber) {\n  return await renderPages(boardName, { allowPrerender: threadNumber || true });\n};\n\nrouter.renderCatalog = async function(boardName) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  await Tools.series(['date', 'recent', 'bumps'], async function(sortMode) {\n    let catalog = await BoardsModel.getCatalog(boardName, sortMode);\n    await Tools.series(catalog.threads, async function(thread) {\n      return await Renderer.renderThread(thread);\n    });\n    let suffix = ('date' !== sortMode) ? `-${sortMode}` : '';\n    await Cache.writeFile(`${boardName}/catalog${suffix}.json`, JSON.stringify(catalog));\n    catalog.title = board.title;\n    catalog.board = MiscModel.board(board).board;\n    catalog.sortMode = sortMode;\n    return Cache.writeFile(`${boardName}/catalog${suffix}.html`, Renderer.render('pages/catalog', catalog));\n  });\n};\n\nrouter.renderArchive = async function(boardName) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  let archive = await BoardsModel.getArchive(boardName);\n  await Cache.writeFile(`${boardName}/archive.json`, JSON.stringify(archive));\n  archive.title = board.title;\n  archive.board = MiscModel.board(board).board;\n  await Cache.writeFile(`${boardName}/archive.html`, Renderer.render('pages/archive', archive));\n};\n\nrouter.renderRSS = async function(boardName) {\n  if (!boardName) {\n    return await Tools.series(Board.boardNames(), router.renderRSS.bind(router));\n  }\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board name: $[1]', '', boardName));\n  }\n  let rssPostCount = config('server.rss.postCount');\n  let Post = await client.collection('post');\n  let posts = await Post.find({ boardName: boardName }, {\n    number: 1,\n    threadNumber: 1,\n    subject: 1,\n    name: 1,\n    text: 1,\n    fileInfos: 1,\n    createdAt: 1\n  }).sort({ createdAt: -1 }).limit(rssPostCount).toArray();\n  if (posts.length <= 0) {\n    return;\n  }\n  posts.sort((p1, p2) => {\n    return +p1.createdAt < +p2.createdAt;\n  });\n  posts.forEach((post) => {\n    if (post.text) {\n      post.text = post.text.split('&nbsp', ' '); //NOTE: Required for the RSS to be valid\n    }\n    post.subject = BoardsModel.postSubject(post, 150) || post.number; //TODO: Magic number\n    let t = (post.name && (post.name.indexOf('span') === -1)) ? post.name.indexOf('#') : -1;\n    if (t > 0) {\n        post.name = post.name.slice(0, t);\n    } else if (t == 0)\n        delete post.name;\n  });\n  let rss = {\n    date: Tools.now(),\n    ttl: config('server.rss.ttl'),\n    board: MiscModel.board(board).board,\n    posts: posts,\n    formattedDate: (date) => {\n      return moment(date).utc().locale('en').format(RSS_DATE_TIME_FORMAT);\n    }\n  };\n  return await Cache.writeFile(`${boardName}/rss.xml`, Renderer.render('pages/rss', rss));\n};\n\nrouter.render = async function(path) {\n  let match = path.match(/^\\/([^\\/]+)\\/rss$/);\n  if (match) {\n    return await router.renderRSS(match[1]);\n  }\n  match = path.match(/^\\/([^\\/]+)$/);\n  if (match) {\n    return await renderPages(match[1]);\n  }\n  match = path.match(/^\\/([^\\/]+)\\/archive$/);\n  if (match) {\n    return await router.renderArchive(match[1]);\n  }\n  match = path.match(/^\\/([^\\/]+)\\/catalog$/);\n  if (match) {\n    return await router.renderCatalog(match[1]);\n  }\n  match = path.match(/^\\/([^\\/]+)\\/res\\/(\\d+)$/);\n  if (match) {\n    return await renderThread(match[1], +match[2]);\n  }\n};\n\nrouter.renderThreadHTML = renderThreadHTML;\n\nfunction installThreadHandler(type) {\n  router.get(`/:boardName/res/:threadNumber.${type}`, async function(req, res, next) {\n    let { boardName, threadNumber } = req.params;\n    threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!threadNumber) {\n      return next(Tools.create404Error(req.baseUrl));\n    }\n    let redirect = await ThreadsModel.getThreadRedirect(boardName, threadNumber);\n    if (!redirect) {\n      return next(Tools.create404Error(req.baseUrl));\n    }\n    res.redirect(301, `/${config('site.pathPrefix')}${redirect.boardName}/res/${redirect.threadNumber}.${type}`);\n  });\n}\n\ninstallThreadHandler('html');\ninstallThreadHandler('json');\n\nexport default router;\n"]}