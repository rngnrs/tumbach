{"version":3,"sources":["controllers/action-posts.js"],"names":["req","boardName","mode","fields","files","postNumber","board","Error","Tools","translate","isArray","fileCount","option","test","testPostNumber","post","PostsModel","getPost","text","rawText","FilesModel","getPostFileCount","testParameters","existingFileCount","Files","IPC","BoardsModel","ThreadsModel","UsersModel","router","Router","res","next","parseForm","markupMode","signAsOp","tripcode","ip","geolocationInfo","checkUserBan","write","markupModes","accessLevel","level","data","options","showTripcode","hashpass","createdAt","now","toISOString","t","name","indexOf","generateTripcode","tt","stripcode","slice","json","transaction","threadNumber","captchaEngine","checkCaptcha","getFiles","checkPostQuota","quota","getThread","closed","unbumpable","thread","processFiles","createPost","archived","send","number","hash","path","redirect","rollback","checkQuota","createThread","date","Date","checkUserPermissions","editPost","length","addFilesToPost","password","sha1","threadExists","isThread","deleteThread","deletePost","fileName","getFileInfoByName","fileInfo","deleteFile","rating","editFileRating","isAudioType","mimeType","editAudioTags"],"mappings":"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","file":"action-posts.js","sourcesContent":["import _ from 'underscore';\nimport express from 'express';\n\nimport Board from '../boards/board';\nimport Captcha from '../captchas/captcha';\nimport * as Files from '../core/files';\nimport geolocation from '../core/geolocation';\nimport config from '../helpers/config';\nimport * as IPC from '../helpers/ipc';\nimport PostCreationTransaction from '../helpers/post-creation-transaction';\nimport * as Tools from '../helpers/tools';\nimport markup from '../markup';\nimport * as BoardsModel from '../models/boards';\nimport * as FilesModel from '../models/files';\nimport * as PostsModel from '../models/posts';\nimport * as ThreadsModel from '../models/threads';\nimport * as UsersModel from '../models/users';\n\nlet router = express.Router();\n\nasync function testParameters(req, boardName, mode, { fields, files, postNumber } = {}) {\n  let board = Board.board(boardName);\n  if (!board) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  if (!fields) {\n    fields = {};\n  }\n  if (!_(files).isArray()) {\n    files = [];\n  }\n  let fileCount = 0;\n  postNumber = Tools.option(postNumber, 'number', 0, { test: Tools.testPostNumber });\n  let post;\n  if (postNumber) {\n    post = await PostsModel.getPost(boardName, postNumber);\n    if (typeof fields.text === 'undefined') {\n      fields.text = post.rawText;\n    }\n    fileCount = await FilesModel.getPostFileCount(boardName, postNumber);\n  }\n  await board.testParameters({\n    req: req,\n    mode: mode,\n    fields: fields,\n    files: files,\n    existingFileCount: fileCount\n  });\n  return post;\n}\n\nrouter.post('/action/markupText', async function(req, res, next) {\n  try {\n    let { fields } = await Files.parseForm(req);\n    let { boardName, text, markupMode, signAsOp, tripcode } = fields;\n    let board = Board.board(boardName);\n    if (!board) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    let rawText = text || '';\n    await testParameters(req, boardName, 'markupText', { fields: fields });\n    markupMode = markupMode || '';\n    let markupModes = markup.markupModes(markupMode);\n    text = await markup(boardName, text, {\n      markupModes: markupModes,\n      accessLevel: req.level(boardName)\n    });\n    let data = {\n      boardName: boardName,\n      text: text || null,\n      rawText: rawText || null,\n      options: {\n        signAsOp: ('true' === signAsOp),\n        showTripcode: (req.hashpass && ('true' === tripcode))\n      },\n      createdAt: Tools.now().toISOString()\n    };\n    let t = fields.name? fields.name.indexOf('#') : -1;\n    if (req.hashpass && tripcode) {\n      data.tripcode = board.generateTripcode(req.hashpass);\n    } else if (t >= 0) {\n        let tt = data.name.indexOf('##');\n        data.tripcode = board.stripcode(fields.name.slice(t+1, tt));\n        if (tt >= 0)\n            data.tripcode += '!' + this.stripcode(data.name.slice(tt+2));\n        data.options.showTripcode = !0;\n    }\n    if (t > 0) {\n        data.name = data.name.slice(0, t);\n    } else if (t == 0)\n        delete data.name;\n    res.json(data);\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/createPost', async function(req, res, next) {\n  let transaction;\n  try {\n    let { fields, files } = await Files.parseForm(req);\n    let { boardName, threadNumber, captchaEngine } = fields;\n    if (!Board.board(boardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!threadNumber) {\n      throw new Error(Tools.translate('Invalid thread'));\n    }\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    await Captcha.checkCaptcha(req, fields);\n    files = await Files.getFiles(fields, files);\n    await testParameters(req, boardName, 'createPost', {\n      fields: fields,\n      files: files\n    });\n    let quota = await UsersModel.checkPostQuota(boardName, req.hashpass || req.ip);\n    if(!quota) {\n      throw new Error(Tools.translate('E-00: Too many posts per time.'));\n    }\n    let thread = await ThreadsModel.getThread(boardName, threadNumber, {\n      closed: 1,\n      unbumpable: 1\n    });\n    if (thread.closed) {\n      throw new Error(Tools.translate('Posting is disabled in this thread'));\n    }\n    transaction = new PostCreationTransaction(boardName);\n    files = await Files.processFiles(boardName, files, transaction);\n    let post = await PostsModel.createPost(req, fields, files, transaction, {\n      unbumpable: thread.unbumpable,\n      archived: thread.archived\n    });\n    IPC.send('notifyAboutNewPosts', `${boardName}/${threadNumber}`);\n    if ('node-captcha-noscript' !== captchaEngine) {\n      res.json({\n        boardName: post.boardName,\n        postNumber: post.number\n      });\n    } else {\n      let hash = `post-${post.number}`;\n      let path = `/${config('site.pathPrefix')}${post.boardName}/res/${post.threadNumber}.html#${hash}`;\n      res.redirect(303, path);\n    }\n  } catch (err) {\n    if (transaction) {\n      transaction.rollback();\n    }\n    next(err);\n  }\n});\n\nrouter.post('/action/createThread', async function(req, res, next) {\n  let transaction;\n  try {\n    let { fields, files } = await Files.parseForm(req);\n    let { boardName, captchaEngine } = fields;\n    if (!Board.board(boardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    await Captcha.checkCaptcha(req, fields);\n    files = await Files.getFiles(fields, files);\n    await testParameters(req, boardName, 'createThread', {\n      fields: fields,\n      files: files\n    });\n    let quota = await BoardsModel.checkQuota(boardName);\n    if(!quota) {\n      throw new Error(Tools.translate('E-00: Too many threads per time.'));\n    }\n    transaction = new PostCreationTransaction(boardName);\n    let thread = await ThreadsModel.createThread(req, fields, transaction);\n    files = await Files.processFiles(boardName, files, transaction);\n    let post = await PostsModel.createPost(req, fields, files, transaction, {\n      postNumber: thread.number,\n      date: new Date(thread.createdAt)\n    });\n    if ('node-captcha-noscript' !== captchaEngine) {\n      res.json({\n        boardName: thread.boardName,\n        threadNumber: thread.number\n      });\n    } else {\n      res.redirect(303, `/${config('site.pathPrefix')}${thread.boardName}/res/${thread.number}.html`);\n    }\n  } catch (err) {\n    if (transaction) {\n      transaction.rollback();\n    }\n    next(err);\n  }\n});\n\nrouter.post('/action/editPost', async function(req, res, next) {\n  try {\n    let { fields } = await Files.parseForm(req);\n    let { boardName, postNumber } = fields;\n    postNumber = Tools.option(postNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!postNumber) {\n      throw new Error(Tools.translate('Invalid post number'));\n    }\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    await UsersModel.checkUserPermissions(req, boardName, postNumber, 'editPost');\n    await testParameters(req, boardName, 'editPost', {\n      fields: fields,\n      postNumber: postNumber\n    });\n    let post = await PostsModel.editPost(req, fields);\n    res.json({\n      boardName: post.boardName,\n      postNumber: post.number\n    });\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/addFiles', async function(req, res, next) {\n  let transaction;\n  try {\n    let { fields, files } = await Files.parseForm(req);\n    let { boardName, postNumber } = fields;\n    if (!Board.board(boardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    postNumber = Tools.option(postNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!postNumber) {\n      throw new Error(Tools.translate('Invalid post number'));\n    }\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    await UsersModel.checkUserPermissions(req, boardName, postNumber, 'addFilesToPost');\n    let post = await PostsModel.getPost(boardName, postNumber);\n    if (!post) {\n      throw new Error(Tools.translate('No such post'));\n    }\n    files = await Files.getFiles(fields, files);\n    if (files.length <= 0) {\n      throw new Error(Tools.translate('No file specified'));\n    }\n    await testParameters(req, boardName, 'addFiles', {\n      fields: fields,\n      files: files,\n      postNumber: postNumber\n    });\n    transaction = new PostCreationTransaction(boardName);\n    files = await Files.processFiles(boardName, files, transaction);\n    await FilesModel.addFilesToPost(boardName, postNumber, files);\n    res.json({});\n  } catch (err) {\n    if (transaction) {\n      transaction.rollback();\n    }\n    next(err);\n  }\n});\n\nrouter.post('/action/deletePost', async function(req, res, next) {\n  try {\n    let { fields } = await Files.parseForm(req);\n    let { boardName, postNumber, password } = fields;\n    if (!Board.board(boardName)) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    postNumber = Tools.option(postNumber, 'number', 0, { test: Tools.testPostNumber });\n    if (!postNumber) {\n      throw new Error(Tools.translate('Invalid post number'));\n    }\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    await UsersModel.checkUserPermissions(req, boardName, postNumber, 'deletePost', Tools.sha1(password));\n    let isThread = await ThreadsModel.threadExists(boardName, postNumber);\n    if (isThread) {\n      await ThreadsModel.deleteThread(boardName, postNumber);\n    } else {\n      await PostsModel.deletePost(boardName, postNumber);\n    }\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/deleteFile', async function(req, res, next) {\n  try {\n    let { fields } = await Files.parseForm(req);\n    let { fileName, password } = fields;\n    if (!fileName || typeof fileName !== 'string') {\n      throw new Error(Tools.translate('Invalid file name'));\n    }\n    let fileInfo = await FilesModel.getFileInfoByName(fileName);\n    if (!fileInfo) {\n      throw new Error(Tools.translate('No such file'));\n    }\n    let { boardName, postNumber } = fileInfo;\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    await UsersModel.checkUserPermissions(req, boardName, postNumber, 'deleteFile', Tools.sha1(password));\n    let post = await testParameters(req, boardName, 'deleteFile', { postNumber: postNumber });\n    await FilesModel.deleteFile(fileName);\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/editFileRating', async function(req, res, next) {\n  try {\n    let { fields } = await Files.parseForm(req);\n    let { fileName, rating, password } = fields;\n    if (!fileName || typeof fileName !== 'string') {\n      throw new Error(Tools.translate('Invalid file name'));\n    }\n    let fileInfo = await FilesModel.getFileInfoByName(fileName);\n    if (!fileInfo) {\n      throw new Error(Tools.translate('No such file'));\n    }\n    let { boardName, postNumber } = fileInfo;\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    await UsersModel.checkUserPermissions(req, boardName, postNumber, 'editFileRating', Tools.sha1(password));\n    await FilesModel.editFileRating(fileName, rating);\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nrouter.post('/action/editAudioTags', async function(req, res, next) {\n  try {\n    let { fields } = await Files.parseForm(req);\n    let { fileName, password } = fields;\n    if (!fileName || typeof fileName !== 'string') {\n      throw new Error(Tools.translate('Invalid file name'));\n    }\n    let fileInfo = await FilesModel.getFileInfoByName(fileName);\n    if (!fileInfo) {\n      throw new Error(Tools.translate('No such file'));\n    }\n    if (!Files.isAudioType(fileInfo.mimeType)) {\n      throw new Error(Tools.translate('Not an audio file'));\n    }\n    let { boardName, postNumber } = fileInfo;\n    req.geolocationInfo = await geolocation(req.ip);\n    await UsersModel.checkUserBan(req.ip, boardName, {\n      write: true,\n      geolocationInfo: req.geolocationInfo\n    });\n    await UsersModel.checkUserPermissions(req, boardName, postNumber, 'editAudioTags', Tools.sha1(password));\n    await FilesModel.editAudioTags(fileName, fields);\n    res.json({});\n  } catch (err) {\n    next(err);\n  }\n});\n\nexport default router;\n"]}