{"version":3,"sources":["server.js"],"names":["Renderer","IPC","OnlineCounter","Tools","BoardsModel","StatisticsModel","UsersModel","generateFileName","fileName","now","toString","lastFileName","Promise","resolve","setTimeout","onReady","ready","initializeUserBansMonitoring","interval","MINUTE","setInterval","generateStatistics","bind","renderRSS","error","stack","console","err","process","exit","initializeMaster","removeOldCaptchImages","createIndexes","compileTemplates","reloadTemplates","generateTemplatingJavaScriptFile","rerender","log","translate","generateCustomJavaScriptFile","generateCustomCSSFiles","on","worker","pid","fork","i","initialize","data","send","enqueueTask","hasNewPosts","isEmpty","catch","SECOND","key","initializeWorker","sockets","WeakSet","server","createServer","ws","listen","status","reject","close","forEach","socket","delete","destroy","clear","type","message","ips","hashpasses","sendMessage","keys","notifyAboutNewPosts","unique","add","isMaster"],"mappings":";;AAEA;;AACA;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;IAAYA,Q;;AACZ;;;;AACA;;;;AACA;;IAAYC,G;;AACZ;;;;AACA;;IAAYC,a;;AACZ;;;;AACA;;IAAYC,K;;AACZ;;IAAYC,W;;AACZ;;IAAYC,e;;AACZ;;IAAYC,U;;AACZ;;;;;;;;;;AAEA,SAASC,gBAAT,GAA4B;AAC1B,MAAIC,WAAW,qBAAEC,GAAF,GAAQC,QAAR,EAAf;AACA,MAAIF,YAAYD,iBAAiBI,YAAjC,EAA+C;AAC7CJ,qBAAiBI,YAAjB,GAAgCH,QAAhC;AACA,WAAOA,QAAP;AACD;AACD,SAAO,IAAII,OAAJ,CAAY,UAACC,OAAD,EAAa;AAC9BC,yDAAW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBACYN,UADZ;;AAAA;AACLA,sBADK;;AAETK,sBAAQL,QAAR;;AAFS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAX,IAGG,CAHH;AAID,GALM,CAAP;AAMD;;AAED,SAASO,OAAT,GAAmB;AACjB;AACA,4CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAEG,gBAAI,CAACA,QAAQC,KAAb,EAAoB;AAClBD,sBAAQC,KAAR,GAAgB,CAAhB;AACD;AACD,cAAED,QAAQC,KAAV;;AALH,kBAMO,sBAAO,oBAAP,MAAiCD,QAAQC,KANhD;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAOWV,WAAWW,4BAAX,EAPX;;AAAA;AAQK,gBAAI,sBAAO,2BAAP,CAAJ,EAAyC;AACnCC,sBADmC,GACxB,sBAAO,uBAAP,IAAkCf,MAAMgB,MADhB;;AAEvCC,0BAAYf,gBAAgBgB,kBAAhB,CAAmCC,IAAnC,CAAwCjB,eAAxC,CAAZ,EAAsEa,QAAtE;AACD;AACD,gBAAI,sBAAO,oBAAP,CAAJ,EAAkC;AAChCE,oEAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAEFnB,IAAIsB,SAAJ,EAFE;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAIR,yCAAOC,KAAP,CAAa,aAAIC,KAAJ,gBAAb;;AAJQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAAZ,IAMG,sBAAO,gBAAP,IAA2BtB,MAAMgB,MANpC;AAOD;AACD;;AArBL;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAwBGO,oBAAQF,KAAR;AACA,gBAAI;AACF,+BAAOA,KAAP,CAAa,aAAIC,KAAJ,gBAAb;AACD,aAFD,CAEE,OAAOE,GAAP,EAAY;AACZD,sBAAQF,KAAR,CAAcG,GAAd;AACD;AACDC,oBAAQC,IAAR,CAAa,CAAb;;AA9BH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAD;AAiCD;;AAED,SAASC,gBAAT,GAA4B;AAC1B;AACA,4CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAES,sBAAYC,qBAAZ,EAFT;;AAAA;AAAA;AAAA,mBAGS,8BAAoBA,qBAApB,EAHT;;AAAA;AAAA;AAAA,mBAIS,sCAAgBC,aAAhB,EAJT;;AAAA;AAAA;AAAA,mBAKShC,SAASiC,gBAAT,EALT;;AAAA;AAAA;AAAA,mBAMSjC,SAASkC,eAAT,EANT;;AAAA;AAAA;AAAA,mBAOSlC,SAASmC,gCAAT,EAPT;;AAAA;AAAA,kBAQO,kBAAQC,QAAR,IAAoB,sBAAO,+BAAP,CAR3B;AAAA;AAAA;AAAA;;AAAA;AAAA,mBASWpC,SAASoC,QAAT,EATX;;AAAA;AAWGV,oBAAQW,GAAR,CAAYlC,MAAMmC,SAAN,CAAgB,wBAAhB,CAAZ;AAXH;AAAA,mBAYSjC,gBAAgBgB,kBAAhB,EAZT;;AAAA;AAAA;AAAA,mBAaSrB,SAASuC,4BAAT,EAbT;;AAAA;AAAA;AAAA,mBAcSvC,SAASwC,sBAAT,EAdT;;AAAA;AAeGd,oBAAQW,GAAR,CAAYlC,MAAMmC,SAAN,CAAgB,iCAAhB,CAAZ;AACA,8BAAQG,EAAR,CAAW,MAAX,EAAmB,UAACC,MAAD,EAAY;AAC7B,+BAAOlB,KAAP,CAAarB,MAAMmC,SAAN,CAAgB,0BAAhB,EAA4C,EAA5C,EAAgDI,OAAOd,OAAP,CAAee,GAA/D,CAAb;AACA,gCAAQC,IAAR;AACD,aAHD;AAIA,iBAASC,CAAT,GAAa,CAAb,EAAgBA,IAAI,sBAAO,oBAAP,CAApB,EAAkD,EAAEA,CAApD,EAAuD;AACrD,gCAAQD,IAAR;AACD;AACD,6BAAOE,UAAP,CAAkB,MAAlB;AACA7C,gBAAIwC,EAAJ,CAAO,OAAP,EAAgB1B,OAAhB;AACAd,gBAAIwC,EAAJ,CAAO,UAAP,EAAmBlC,gBAAnB;AACAN,gBAAIwC,EAAJ,CAAO,iBAAP,EAA0B,UAACM,IAAD,EAAU;AAClC,qBAAO9C,IAAI+C,IAAJ,CAAS,iBAAT,EAA4BD,IAA5B,CAAP;AACD,aAFD;AAGA9C,gBAAIwC,EAAJ,CAAO,MAAP,EAAe,YAAM;AACnB,qBAAOxC,IAAI+C,IAAJ,CAAS,MAAT,CAAP;AACD,aAFD;AAGA/C,gBAAIwC,EAAJ,CAAO,OAAP,EAAgB,YAAM;AACpB,qBAAOxC,IAAI+C,IAAJ,CAAS,OAAT,CAAP;AACD,aAFD;AAGA/C,gBAAIwC,EAAJ,CAAO,cAAP,4CAAuB;AAAA;AAAA;AAAA;AAAA;AACrB,sCAAMK,UAAN;AADqB;AAAA,6BAEf7C,IAAI+C,IAAJ,CAAS,cAAT,CAFe;;AAAA;AAAA;AAAA,6BAGf/C,IAAIgD,WAAJ,CAAgB,cAAhB,CAHe;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aAAvB;AAKAhD,gBAAIwC,EAAJ,CAAO,iBAAP,4CAA0B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6BAClBzC,SAASiC,gBAAT,EADkB;;AAAA;AAAA;AAAA,6BAElBjC,SAASkC,eAAT,EAFkB;;AAAA;AAAA;AAAA,6BAGlBlC,SAASmC,gCAAT,EAHkB;;AAAA;AAAA;AAAA,6BAIlBlC,IAAI+C,IAAJ,CAAS,iBAAT,CAJkB;;AAAA;AAAA;AAAA,6BAKlB/C,IAAIgD,WAAJ,CAAgB,iBAAhB,CALkB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aAA1B;AAOIC,uBA/CP,GA+CqB,EA/CrB;;AAgDG9B,wBAAY,YAAM;AAChB,kBAAI,0BAAE8B,WAAF,EAAeC,OAAf,EAAJ,EAA8B;AAC5B;AACD;AACDlD,kBAAI+C,IAAJ,CAAS,qBAAT,EAAgCE,WAAhC,EAA6CE,KAA7C,CAAmD,UAACzB,GAAD,EAAS;AAC1D,iCAAOH,KAAP,CAAaG,IAAIF,KAAJ,IAAaE,GAA1B;AACD,eAFD;AAGAuB,4BAAc,EAAd;AACD,aARD,EAQG/C,MAAMkD,MART;AASApD,gBAAIwC,EAAJ,CAAO,qBAAP,EAA8B,UAACa,GAAD,EAAS;AACrCJ,0BAAYI,GAAZ,IAAmB,CAAnB;AACD,aAFD;AAzDH;AAAA;;AAAA;AAAA;AAAA;;AA6DG,6BAAO9B,KAAP,CAAa,aAAIC,KAAJ,gBAAb;AACAG,oBAAQC,IAAR,CAAa,CAAb;;AA9DH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAD;AAiED;;AAED,SAAS0B,gBAAT,GAA4B;AAC1B;AACA,4CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AACC7B,oBAAQW,GAAR,CAAYlC,MAAMmC,SAAN,CAAgB,sBAAhB,EAAwC,EAAxC,EAA4CV,QAAQe,GAApD,CAAZ;AADD;AAAA;AAAA,mBAGS,sBAAYG,UAAZ,EAHT;;AAAA;AAAA;AAAA,mBAIS1C,YAAY0C,UAAZ,EAJT;;AAAA;AAAA;AAAA,mBAKS9C,SAASkC,eAAT,EALT;;AAAA;AAMOsB,mBANP,GAMiB,IAAIC,OAAJ,EANjB;AAOOC,kBAPP,GAOgB,eAAKC,YAAL,uBAPhB;AAQOC,cARP,GAQY,8BAAoBF,MAApB,CARZ;;AASGA,mBAAOG,MAAP,CAAc,sBAAO,aAAP,CAAd,EAAqC,YAAM;AACzCnC,sBAAQW,GAAR,CAAYlC,MAAMmC,SAAN,CAAgB,+BAAhB,EAAiD,EAAjD,EAAqDV,QAAQe,GAA7D,EAAkE,sBAAO,aAAP,CAAlE,CAAZ;AACA1C,kBAAIwC,EAAJ,CAAO,MAAP,EAAe,UAACqB,MAAD,EAAY;AAAElC,wBAAQC,IAAR,CAAaiC,MAAb;AAAuB,eAApD;AACA7D,kBAAIwC,EAAJ,CAAO,MAAP,EAAe,YAAM;AACnB,uBAAO,IAAI7B,OAAJ,CAAY,UAACC,OAAD,EAAUkD,MAAV,EAAqB;AACtCL,yBAAOM,KAAP,CAAa,YAAM;AACjBR,4BAAQS,OAAR,CAAgB,UAACC,MAAD,EAAY;AAC1BV,8BAAQW,MAAR,CAAeD,MAAf;AACAA,6BAAOE,OAAP;AACD,qBAHD;AAIAlE,kCAAcmE,KAAd;AACA3C,4BAAQW,GAAR,CAAYlC,MAAMmC,SAAN,CAAgB,eAAhB,EAAiC,EAAjC,EAAqCV,QAAQe,GAA7C,CAAZ;AACA9B;AACD,mBARD;AASD,iBAVM,CAAP;AAWD,eAZD;AAaAZ,kBAAIwC,EAAJ,CAAO,OAAP,EAAgB,YAAM;AACpB,uBAAO,IAAI7B,OAAJ,CAAY,UAACC,OAAD,EAAUkD,MAAV,EAAqB;AACtCL,yBAAOG,MAAP,CAAc,sBAAO,aAAP,CAAd,EAAqC,YAAM;AACzCnC,4BAAQW,GAAR,CAAYlC,MAAMmC,SAAN,CAAgB,gCAAhB,EAAkD,EAAlD,EAAsDV,QAAQe,GAA9D,EAAmE,sBAAO,aAAP,CAAnE,CAAZ;AACA9B;AACD,mBAHD;AAID,iBALM,CAAP;AAMD,eAPD;AAQAZ,kBAAIwC,EAAJ,CAAO,iBAAP,EAA0B,YAA6C;AAAA,gGAAP,EAAO;AAAA,oBAA1C6B,IAA0C,SAA1CA,IAA0C;AAAA,oBAApCC,OAAoC,SAApCA,OAAoC;AAAA,oBAA3BC,GAA2B,SAA3BA,GAA2B;AAAA,oBAAtBC,UAAsB,SAAtBA,UAAsB;;AACrEb,mBAAGc,WAAH,CAAeJ,IAAf,EAAqBC,OAArB,EAA8BC,GAA9B,EAAmCC,UAAnC;AACD,eAFD;AAGAxE,kBAAIwC,EAAJ,CAAO,cAAP,EAAuB,YAAM;AAC3B,gCAAMK,UAAN;AACD,eAFD;AAGA7C,kBAAIwC,EAAJ,CAAO,iBAAP,4CAA0B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BACXzC,SAASkC,eAAT,EADW;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAA1B;AAGAjC,kBAAIwC,EAAJ,CAAO,qBAAP,EAA8B,UAACkC,IAAD,EAAU;AACtCf,mBAAGgB,mBAAH,CAAuBD,IAAvB;AACD,eAFD;AAGA1E,kBAAIwC,EAAJ,CAAO,kBAAP,EAA2B,YAAM;AAC9B,uBAAOvC,cAAc2E,MAAd,EAAP;AACF,eAFD;AAGA5E,kBAAI+C,IAAJ,CAAS,OAAT,EAAkBI,KAAlB,CAAwB,UAACzB,GAAD,EAAS;AAC/B,iCAAOH,KAAP,CAAaG,GAAb;AACD,eAFD;AAGD,aA1CD;AA2CA+B,mBAAOjB,EAAP,CAAU,YAAV,EAAwB,UAACyB,MAAD,EAAY;AAClCV,sBAAQsB,GAAR,CAAYZ,MAAZ;AACAA,qBAAOzB,EAAP,CAAU,OAAV,EAAmB,YAAM;AACvBe,wBAAQW,MAAR,CAAeD,MAAf;AACD,eAFD;AAGD,aALD;AApDH;AAAA;;AAAA;AAAA;AAAA;;AA2DGxC,oBAAQF,KAAR;AACA,gBAAI;AACF,+BAAOA,KAAP,CAAa,aAAIC,KAAJ,gBAAb;AACD,aAFD,CAEE,OAAOE,GAAP,EAAY;AACZD,sBAAQF,KAAR,CAAcG,GAAd;AACD;AACDC,oBAAQC,IAAR,CAAa,CAAb;;AAjEH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAD;AAoED;;AAED,gBAAMiB,UAAN;AACA,kBAAQA,UAAR;AACA,sBAAYA,UAAZ;;AAEA,IAAI,kBAAQiC,QAAZ,EAAsB;AACpBjD;AACD,CAFD,MAEO;AACLyB;AACD;;AAED3B,QAAQa,EAAR,CAAW,mBAAX,EAAgC,UAASd,GAAT,EAAc;AAC5CD,UAAQW,GAAR,CAAYV,GAAZ;AACD,CAFD","file":"server.js","sourcesContent":["\n\nimport 'babel-polyfill';\nimport 'source-map-support/register';\nimport _ from 'underscore';\nimport Cluster from 'cluster';\nimport HTTP from 'http';\n\nimport Board from './boards/board';\nimport Captcha from './captchas/captcha';\nimport NodeCaptcha from './captchas/node-captcha';\nimport NodeCaptchaNoscript from './captchas/node-captcha-noscript';\nimport commands from './commands';\nimport controllers from './controllers';\nimport geolocation from './core/geolocation';\nimport * as Renderer from './core/renderer';\nimport WebSocketServer from './core/websocket-server';\nimport config from './helpers/config';\nimport * as IPC from './helpers/ipc';\nimport Logger from './helpers/logger';\nimport * as OnlineCounter from './helpers/online-counter';\nimport Program from './helpers/program';\nimport * as Tools from './helpers/tools';\nimport * as BoardsModel from './models/boards';\nimport * as StatisticsModel from './models/statistics';\nimport * as UsersModel from './models/users';\nimport mongodbClient from './storage/mongodb-client-factory';\n\nfunction generateFileName() {\n  let fileName = _.now().toString();\n  if (fileName != generateFileName.lastFileName) {\n    generateFileName.lastFileName = fileName;\n    return fileName;\n  }\n  return new Promise((resolve) => {\n    setTimeout(async function() {\n      let fileName = await fileName();\n      resolve(fileName);\n    }, 1);\n  });\n}\n\nfunction onReady() {\n  //NOTE: Overcoming Babel bug\n  (async function() {\n    try {\n      if (!onReady.ready) {\n        onReady.ready = 0;\n      }\n      ++onReady.ready;\n      if (config('system.workerCount') === onReady.ready) {\n        await UsersModel.initializeUserBansMonitoring();\n        if (config('server.statistics.enabled')) {\n          let interval = config('server.statistics.ttl') * Tools.MINUTE;\n          setInterval(StatisticsModel.generateStatistics.bind(StatisticsModel), interval);\n        }\n        if (config('server.rss.enabled')) {\n          setInterval(async function() {\n            try {\n              await IPC.renderRSS();\n            } catch (err) {\n              Logger.error(err.stack || err);\n            }\n          }, config('server.rss.ttl') * Tools.MINUTE);\n        }\n        commands();\n      }\n    } catch (err) {\n      console.error(err);\n      try {\n        Logger.error(err.stack || err);\n      } catch (err) {\n        console.error(err);\n      }\n      process.exit(1);\n    }\n  })();\n}\n\nfunction initializeMaster() {\n  //NOTE: Overcoming Babel bug\n  (async function() {\n    try {\n      await NodeCaptcha.removeOldCaptchImages();\n      await NodeCaptchaNoscript.removeOldCaptchImages();\n      await mongodbClient().createIndexes();\n      await Renderer.compileTemplates();\n      await Renderer.reloadTemplates();\n      await Renderer.generateTemplatingJavaScriptFile();\n      if (Program.rerender || config('system.rerenderCacheOnStartup')) {\n        await Renderer.rerender();\n      }\n      console.log(Tools.translate('Generating statistics…'));\n      await StatisticsModel.generateStatistics();\n      await Renderer.generateCustomJavaScriptFile();\n      await Renderer.generateCustomCSSFiles();\n      console.log(Tools.translate('Spawning workers, please, wait…'));\n      Cluster.on('exit', (worker) => {\n        Logger.error(Tools.translate('[$[1]] Died, respawning…', '', worker.process.pid));\n        Cluster.fork();\n      });\n      for (let i = 0; i < config('system.workerCount'); ++i) {\n        Cluster.fork();\n      }\n      Logger.initialize('main');\n      IPC.on('ready', onReady);\n      IPC.on('fileName', generateFileName);\n      IPC.on('sendChatMessage', (data) => {\n        return IPC.send('sendChatMessage', data);\n      });\n      IPC.on('stop', () => {\n        return IPC.send('stop');\n      });\n      IPC.on('start', () => {\n        return IPC.send('start');\n      });\n      IPC.on('reloadBoards', async function() {\n        Board.initialize();\n        await IPC.send('reloadBoards');\n        await IPC.enqueueTask('reloadBoards');\n      });\n      IPC.on('reloadTemplates', async function() {\n        await Renderer.compileTemplates();\n        await Renderer.reloadTemplates();\n        await Renderer.generateTemplatingJavaScriptFile();\n        await IPC.send('reloadTemplates');\n        await IPC.enqueueTask('reloadTemplates');\n      });\n      let hasNewPosts = {};\n      setInterval(() => {\n        if (_(hasNewPosts).isEmpty()) {\n          return;\n        }\n        IPC.send('notifyAboutNewPosts', hasNewPosts).catch((err) => {\n          Logger.error(err.stack || err);\n        });\n        hasNewPosts = {};\n      }, Tools.SECOND);\n      IPC.on('notifyAboutNewPosts', (key) => {\n        hasNewPosts[key] = 1;\n      });\n    } catch (err) {\n      Logger.error(err.stack || err);\n      process.exit(1);\n    }\n  })();\n}\n\nfunction initializeWorker() {\n  //NOTE: Overcoming Babel bug\n  (async function() {\n    console.log(Tools.translate('[$[1]] Initializing…', '', process.pid));\n    try {\n      await geolocation.initialize();\n      await BoardsModel.initialize();\n      await Renderer.reloadTemplates();\n      let sockets = new WeakSet();\n      let server = HTTP.createServer(controllers);\n      let ws = new WebSocketServer(server);\n      server.listen(config('server.port'), () => {\n        console.log(Tools.translate('[$[1]] Listening on port $[2]', '', process.pid, config('server.port')));\n        IPC.on('exit', (status) => { process.exit(status); });\n        IPC.on('stop', () => {\n          return new Promise((resolve, reject) => {\n            server.close(() => {\n              sockets.forEach((socket) => {\n                sockets.delete(socket);\n                socket.destroy();\n              });\n              OnlineCounter.clear();\n              console.log(Tools.translate('[$[1]] Closed', '', process.pid));\n              resolve();\n            });\n          });\n        });\n        IPC.on('start', () => {\n          return new Promise((resolve, reject) => {\n            server.listen(config('server.port'), () => {\n              console.log(Tools.translate('[$[1]] Listening on port $[2]…', '', process.pid, config('server.port')));\n              resolve();\n            });\n          });\n        });\n        IPC.on('sendChatMessage', ({ type, message, ips, hashpasses } = {}) => {\n          ws.sendMessage(type, message, ips, hashpasses);\n        });\n        IPC.on('reloadBoards', () => {\n          Board.initialize();\n        });\n        IPC.on('reloadTemplates', async function() {\n          return await Renderer.reloadTemplates();\n        });\n        IPC.on('notifyAboutNewPosts', (keys) => {\n          ws.notifyAboutNewPosts(keys);\n        });\n        IPC.on('getConnectionIPs', () => {\n           return OnlineCounter.unique();\n        });\n        IPC.send('ready').catch((err) => {\n          Logger.error(err);\n        });\n      });\n      server.on('connection', (socket) => {\n        sockets.add(socket);\n        socket.on('close', () => {\n          sockets.delete(socket);\n        });\n      });\n    } catch (err) {\n      console.error(err);\n      try {\n        Logger.error(err.stack || err);\n      } catch (err) {\n        console.error(err);\n      }\n      process.exit(1);\n    }\n  })();\n}\n\nBoard.initialize();\nCaptcha.initialize();\ncontrollers.initialize();\n\nif (Cluster.isMaster) {\n  initializeMaster();\n} else {\n  initializeWorker();\n}\n\nprocess.on('uncaughtException', function(err) {\n  console.log(err);\n});\n"]}