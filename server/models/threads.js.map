{"version":3,"sources":["models/threads.js"],"names":["boardName","threadNumber","archived","source","ArchivedThreadPostNumbers","ThreadPostNumbers","count","getThreadPostCount","getAll","postNumbers","length","sort","a","b","getThreadPostNumbers","postNumber","addOne","addThreadPostNumber","deleteOne","removeThreadPostNumber","thread","withPostNumbers","ArchivedThreadUpdateTimes","ThreadUpdateTimes","getOne","number","updatedAt","addDataToThread","reverse","limit","notOP","withExtraData","withFileInfos","withReferences","board","Promise","reject","Error","Tools","translate","option","test","testPostNumber","splice","l","PostsModel","getPosts","getThreadPosts","ArchivedThreads","Threads","keys","getThreadNumbers","options","getThread","threadNumbers","isArray","map","some","getSome","threads","toArray","mayBeArchivedThreadNumbers","index","filter","numbers","archivedThreads","forEach","series","getThreads","lastPostNumber","postCount","newPostCount","pn","bumpLimit","postLimit","bumpLimitReached","postLimitReached","closed","fixed","unbumpable","postingEnabled","pop","getThreadInfo","threadPostNumbers","last","getThreadLastPostNumber","dateTme","setOne","setThreadUpdateTime","DeletedThreads","contains","isThreadDeleted","setThreadDeleted","delete","clearDeletedThreads","key","ThreadsPlannedForDeletion","updateTimeSource","setTimeout","postNumbersSource","removePost","removingThread","error","stack","removeThread","sortThreadsByDate","threadLimit","client","transaction","archivedThreadNumbers","removeLastArchivedThread","archiveLimit","commit","IPC","renderArchive","addSome","pushPostToArchive","archivePath","__dirname","oldThreadNumber","mkpath","sourceId","Cache","readFile","data","model","JSON","parse","write","stringify","renderThreadHTML","targetPath","removeFile","rollback","pushOutOldThread","req","fields","password","date","now","sha1","hashpass","BoardsModel","nextPostNumber","createdAt","toISOString","user","ip","level","setThreadNumber","createThread","sourceBoardName","targetBoardName","targetBoard","initialPostNumber","copyPosts","toRerender","toUpdate","postNumberMap","render","reduce","acc","ref","rerenderMovedThreadRelatedPosts","posts","updateMovedThreadRelatedPosts","sourceThreadNumber","targetThreadNumber","moveThread","setThreadFixed","setThreadClosed","setThreadUnbumpable","sortThreadsByCreationDate","sortThreadsByPostCount","Search","toString","t1","t2","localeCompare"],"mappings":"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","file":"models/threads.js","sourcesContent":["import _ from 'underscore';\nimport FS from 'q-io/fs';\nimport promisify from 'promisify-node';\n\nimport * as BoardsModel from './boards';\nimport * as PostsModel from './posts';\nimport Board from '../boards/board';\nimport BoardController from '../controllers/board';\nimport * as Search from '../core/search';\nimport * as Cache from '../helpers/cache';\nimport * as IPC from '../helpers/ipc';\nimport Logger from '../helpers/logger';\nimport * as Tools from '../helpers/tools';\nimport redisClient from '../storage/redis-client-factory';\nimport sqlClient from '../storage/sql-client-factory';\nimport Hash from '../storage/hash';\nimport UnorderedSet from '../storage/unordered-set';\n\nconst mkpath = promisify('mkpath');\n\nlet ArchivedThreadPostNumbers = new UnorderedSet(sqlClient(), 'archivedThreadPostNumbers', {\n  parse: number => +number,\n  stringify: number => number.toString()\n});\nlet ArchivedThreads = new Hash(sqlClient(), 'archivedThreads');\nlet ArchivedThreadUpdateTimes = new Hash(sqlClient(), 'archivedThreadUpdateTimes', {\n  parse: false,\n  stringify: false\n});\nlet DeletedThreads = new UnorderedSet(redisClient(), 'deletedThreads', {\n  parse: false,\n  stringify: false\n});\nlet ThreadPostNumbers = new UnorderedSet(redisClient(), 'threadPostNumbers', {\n  parse: number => +number,\n  stringify: number => number.toString()\n});\nlet Threads = new Hash(redisClient(), 'threads');\nlet ThreadsPlannedForDeletion = new UnorderedSet(redisClient(), 'threadsPlannedForDeletion', {\n  parse: false,\n  stringify: false\n});\nlet ThreadUpdateTimes = new Hash(redisClient(), 'threadUpdateTimes', {\n  parse: false,\n  stringify: false\n});\n\nexport function sortThreadsByDate(t1, t2) {\n  if (!!t1.fixed === !!t2.fixed) {\n    return t2.updatedAt.localeCompare(t1.updatedAt);\n  } else {\n    return t1.fixed ? -1 : 1;\n  }\n}\n\nexport function sortThreadsByCreationDate(t1, t2) {\n  return t2.createdAt.localeCompare(t1.createdAt);\n}\n\nexport function sortThreadsByPostCount(t1, t2) {\n  return t2.postCount - t1.postCount;\n}\n\nexport async function getThreadPostCount(boardName, threadNumber, { archived } = {}) {\n  let source = archived ? ArchivedThreadPostNumbers : ThreadPostNumbers;\n  return await source.count(`${boardName}:${threadNumber}`);\n}\n\nexport async function getThreadPostNumbers(boardName, threadNumber) {\n  let postNumbers = await ThreadPostNumbers.getAll(`${boardName}:${threadNumber}`);\n  if (!postNumbers || postNumbers.length <= 0) {\n    postNumbers = await ArchivedThreadPostNumbers.getAll(`${boardName}:${threadNumber}`);\n  }\n  return postNumbers.sort((a, b) => { return a - b; });\n}\n\nexport async function addThreadPostNumber(boardName, threadNumber, postNumber, { archived } = {}) {\n  let source = archived ? ArchivedThreadPostNumbers : ThreadPostNumbers;\n  await source.addOne(postNumber, `${boardName}:${threadNumber}`);\n}\n\nexport async function removeThreadPostNumber(boardName, threadNumber, postNumber, { archived } = {}) {\n  let source = archived ? ArchivedThreadPostNumbers : ThreadPostNumbers;\n  await source.deleteOne(postNumber, `${boardName}:${threadNumber}`);\n}\n\nasync function addDataToThread(thread, { withPostNumbers } = {}) {\n  let source = thread.archived ? ArchivedThreadUpdateTimes : ThreadUpdateTimes;\n  thread.updatedAt = await source.getOne(thread.number, thread.boardName);\n  if (withPostNumbers) {\n    thread.postNumbers = await getThreadPostNumbers(thread.boardName, thread.number);\n  }\n}\n\nexport async function getThreadPosts(boardName, threadNumber,\n  { reverse, limit, notOP, withExtraData, withFileInfos, withReferences } = {}) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let postNumbers = await getThreadPostNumbers(boardName, threadNumber);\n  if (notOP) {\n    postNumbers.splice(0, 1);\n  }\n  if (reverse) {\n    postNumbers.reverse();\n  }\n  limit = Tools.option(limit, 'number', 0, { test: (l) => { return l > 0; } });\n  if (limit) {\n    postNumbers.splice(limit);\n  }\n  return await PostsModel.getPosts(boardName, postNumbers, { withExtraData, withFileInfos, withReferences });\n}\n\nexport async function getThreadNumbers(boardName, { archived } = {}) {\n  let source = archived ? ArchivedThreads : Threads;\n  return await source.keys(boardName);\n}\n\nexport async function getThread(boardName, threadNumber, options) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let thread = await Threads.getOne(threadNumber, boardName);\n  if (!thread) {\n    thread = await ArchivedThreads.getOne(threadNumber, boardName);\n  }\n  if (!thread) {\n    return Promise.reject(new Error(Tools.translate('No such thread')));\n  }\n  await addDataToThread(thread, options);\n  return thread;\n}\n\nexport async function getThreads(boardName, threadNumbers, options) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  if (!_(threadNumbers).isArray()) {\n    threadNumbers = [threadNumbers];\n  }\n  threadNumbers = threadNumbers.map((threadNumber) => {\n    return Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  });\n  if (threadNumbers.some(threadNumber => !threadNumber)) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let threads = await Threads.getSome(threadNumbers, boardName);\n  threads = _(threads).toArray();\n  let mayBeArchivedThreadNumbers = threads.map((thread, index) => {\n    return {\n      thread: thread,\n      index: index\n    };\n  }).filter((thread) => !thread.thread).map((thread) => {\n    return {\n      index: thread.index,\n      threadNumber: threadNumbers[thread.index]\n    };\n  });\n  if (mayBeArchivedThreadNumbers.length > 0) {\n    let numbers = mayBeArchivedThreadNumbers.map(thread => thread.threadNumber);\n    let archivedThreads = await ArchivedThreads.getSome(numbers, boardName);\n    archivedThreads.forEach((thread, index) => {\n      threads[mayBeArchivedThreadNumbers[index].index] = thread;\n    });\n  }\n  if (threads.length <= 0) {\n    return [];\n  }\n  await Tools.series(threads, async function(thread) {\n    await addDataToThread(thread, options);\n  });\n  return threads;\n}\n\nexport async function getThreadInfo(boardName, threadNumber, { lastPostNumber }) {\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let thread = await getThread(boardName, threadNumber, { withPostNumbers: true });\n  if (!thread) {\n    return thread;\n  }\n  let postCount = thread.postNumbers.length;\n  lastPostNumber = Tools.option(lastPostNumber, 'number', 0, { test: Tools.testPostNumber });\n  let newPostCount = thread.postNumbers.filter((pn) => { return pn > lastPostNumber; }).length;\n  return {\n    number: thread.number,\n    bumpLimit: board.bumpLimit,\n    postLimit: board.postLimit,\n    bumpLimitReached: (postCount >= board.bumpLimit),\n    postLimitReached: (postCount >= board.postLimit),\n    closed: thread.closed,\n    fixed: thread.fixed,\n    unbumpable: thread.unbumpable,\n    postCount: postCount,\n    postingEnabled: (board.postingEnabled && !thread.closed),\n    lastPostNumber: thread.postNumbers.pop(),\n    newPostCount: newPostCount\n  };\n}\n\nexport async function getThreadLastPostNumber(boardName, threadNumber) {\n  if (!Board.board(boardName)) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    return Promise.reject(new Error(Tools.translate('Invalid thread number')));\n  }\n  let threadPostNumbers = await getThreadPostNumbers(boardName, threadNumber);\n  return (threadPostNumbers.length > 0) ? _(threadPostNumbers).last() : 0;\n}\n\nexport async function setThreadUpdateTime(boardName, threadNumber, dateTme, { archived } = {}) {\n  let source = archived ? ArchivedThreadUpdateTimes : ThreadUpdateTimes;\n  await source.setOne(threadNumber, dateTme, boardName);\n}\n\nexport async function isThreadDeleted(boardName, threadNumber) {\n  return DeletedThreads.contains(`${boardName}:${threadNumber}`);\n}\n\nexport async function setThreadDeleted(boardName, threadNumber) {\n  return DeletedThreads.addOne(`${boardName}:${threadNumber}`);\n}\n\nexport async function clearDeletedThreads() {\n  return DeletedThreads.delete();\n}\n\nexport async function removeThread(boardName, threadNumber, { archived } = {}) {\n  let source = archived ? ArchivedThreads : Threads;\n  let key = `${boardName}:${threadNumber}`\n  await ThreadsPlannedForDeletion.addOne(key);\n  await source.deleteOne(threadNumber, boardName);\n  let updateTimeSource = archived ? ArchivedThreadUpdateTimes : ThreadUpdateTimes;\n  await updateTimeSource.deleteOne(threadNumber, boardName);\n  setTimeout(async function() {\n    try {\n      let postNumbers = await getThreadPostNumbers(boardName, threadNumber);\n      let postNumbersSource = archived ? ArchivedThreadPostNumbers : ThreadPostNumbers;\n      await postNumbersSource.delete(key);\n      await Tools.series(postNumbers, async function(postNumber) {\n        return await PostsModel.removePost(boardName, postNumber, { removingThread: true });\n      });\n      await ThreadsPlannedForDeletion.deleteOne(key);\n    } catch (err) {\n      Logger.error(err.stack || err);\n    }\n  }, 5000); //TODO: This is not OK\n}\n\nasync function pushOutOldThread(boardName) {\n  try {\n    let board = Board.board(boardName);\n    if (!board) {\n      throw new Error(Tools.translate('Invalid board'));\n    }\n    let threadNumbers = await getThreadNumbers(boardName);\n    let threads = await getThreads(boardName, threadNumbers);\n    threads.sort(sortThreadsByDate);\n    if (threads.length < board.threadLimit) {\n      return;\n    }\n    let client = await sqlClient();\n    await client.transaction();\n    let archivedThreadNumbers = await getThreadNumbers(boardName, { archived: true });\n    let archivedThreads = await getThreads(boardName, archivedThreadNumbers);\n    archivedThreads.sort(sortThreadsByDate);\n    let removeLastArchivedThread = (archivedThreads.length > 0) && (archivedThreads.length >= board.archiveLimit);\n    if (removeLastArchivedThread) {\n      await removeThread(boardName, archivedThreads.pop().number, { archived: true });\n    }\n    let thread = threads.pop();\n    if (board.archiveLimit <= 0) {\n      await removeThread(boardName, thread.number);\n      await client.commit();\n      if (removeLastArchivedThread) {\n        await IPC.renderArchive(boardName);\n      }\n      return;\n    }\n    await Threads.deleteOne(thread.number, boardName);\n    (async function() {\n      try {\n        ArchivedThreadUpdateTimes.setOne(thread.number, thread.updatedAt, boardName);\n        ThreadUpdateTimes.deleteOne(thread.number, boardName);\n        thread.archived = true;\n        delete thread.updatedAt;\n        await ArchivedThreads.setOne(thread.number, thread, boardName);\n        let key = `${boardName}:${thread.number}`;\n        let postNumbers = await getThreadPostNumbers(boardName, thread.number);\n        await ArchivedThreadPostNumbers.addSome(postNumbers, key);\n        await ThreadPostNumbers.delete(key);\n        await Tools.series(postNumbers, async function(postNumber) {\n          await PostsModel.pushPostToArchive(boardName, postNumber);\n        });\n        await client.commit();\n        let archivePath = `${__dirname}/../../public/${boardName}/arch`;\n        let oldThreadNumber = thread.number;\n        await mkpath(archivePath);\n        let sourceId = `${boardName}/res/${oldThreadNumber}.json`;\n        let data = await Cache.readFile(sourceId);\n        let model = JSON.parse(data);\n        model.thread.archived = true;\n        await FS.write(`${archivePath}/${oldThreadNumber}.json`, JSON.stringify(model));\n        await BoardController.renderThreadHTML(model.thread, {\n          targetPath: `${archivePath}/${oldThreadNumber}.html`,\n          archived: true\n        });\n        await Cache.removeFile(sourceId);\n        await Cache.removeFile(`${boardName}/res/${oldThreadNumber}.html`);\n        await IPC.renderArchive(boardName);\n      } catch (err) {\n        client.rollback();\n        Logger.error(err.stack || err);\n      }\n    })();\n    //NOTE: This is for the sake of speed.\n  } catch (err) {\n    client.rollback();\n    Logger.error(err.stack || err);\n  }\n}\n\nexport async function createThread(req, fields, transaction) {\n  let { boardName, password } = fields;\n  let board = Board.board(boardName);\n  if (!board) {\n    return Promise.reject(new Error(Tools.translate('Invalid board')));\n  }\n  if (!board.postingEnabled) {\n    return Promise.reject(new Error(Tools.translate('Posting is disabled at this board')));\n  }\n  await pushOutOldThread(boardName);\n  let date = Tools.now();\n  password = Tools.sha1(password);\n  let hashpass = (req.hashpass || null);\n  let threadNumber = await BoardsModel.nextPostNumber(boardName);\n  let thread = {\n    archived: false,\n    boardName: boardName,\n    closed: false,\n    createdAt: date.toISOString(),\n    fixed: false,\n    unbumpable: false,\n    number: threadNumber,\n    user: {\n      hashpass: hashpass,\n      ip: req.ip,\n      level: req.level(boardName),\n      password: password\n    }\n  };\n  transaction.setThreadNumber(threadNumber);\n  await Threads.setOne(threadNumber, thread, boardName);\n  return thread;\n}\n\nexport async function moveThread(sourceBoardName, threadNumber, targetBoardName) {\n  let targetBoard = Board.board(targetBoardName);\n  if (!targetBoard || !Board.board(sourceBoardName)) {\n    throw new Error(Tools.translate('Invalid board'));\n  }\n  threadNumber = Tools.option(threadNumber, 'number', 0, { test: Tools.testPostNumber });\n  if (!threadNumber) {\n    throw new Error(Tools.translate('Invalid thread number'));\n  }\n  let thread = await getThread(sourceBoardName, threadNumber, { withPostNumbers: true });\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  let postNumbers = thread.postNumbers;\n  delete thread.postNumbers;\n  delete thread.updatedAt;\n  thread.boardName = targetBoardName;\n  let lastPostNumber = await BoardsModel.nextPostNumber(targetBoardName, postNumbers.length);\n  let initialPostNumber = lastPostNumber - postNumbers.length + 1;\n  thread.number = initialPostNumber;\n  let { toRerender, toUpdate, postNumberMap } = await PostsModel.copyPosts({\n    sourceBoardName: sourceBoardName,\n    postNumbers: postNumbers,\n    targetBoardName: targetBoardName,\n    initialPostNumber: initialPostNumber\n  });\n  await ThreadPostNumbers.addSome(_(postNumberMap).toArray(), `${targetBoardName}:${thread.number}`);\n  await ThreadUpdateTimes.setOne(thread.number, Tools.now().toISOString(), targetBoardName);\n  await Threads.setOne(thread.number, thread, targetBoardName);\n  await IPC.render(targetBoardName, thread.number, thread.number, 'create');\n  toRerender = toRerender.reduce((acc, ref) => {\n    acc[`${ref.boardName}:${ref.postNumber}`] = ref;\n    return acc;\n  }, {});\n  toUpdate = toUpdate.reduce((acc, ref) => {\n    acc[`${ref.boardName}:${ref.threadNumber}`] = ref;\n    return acc;\n  }, {});\n  await PostsModel.rerenderMovedThreadRelatedPosts({\n    posts: toRerender,\n    sourceBoardName: sourceBoardName,\n    targetBoardName: targetBoardName,\n    postNumberMap: postNumberMap\n  });\n  await PostsModel.updateMovedThreadRelatedPosts({\n    posts: toUpdate,\n    sourceBoardName: sourceBoardName,\n    targetBoardName: targetBoardName,\n    sourceThreadNumber: threadNumber,\n    targetThreadNumber: initialPostNumber,\n    postNumberMap: postNumberMap\n  });\n  await Tools.series(toRerender, async function(ref) {\n    return await IPC.render(ref.boardName, ref.threadNumber, ref.postNumber, 'edit');\n  });\n  await Tools.series(toUpdate, async function(ref) {\n    return await IPC.render(ref.boardName, ref.threadNumber, ref.threadNumber, 'create');\n  });\n  await removeThread(sourceBoardName, threadNumber);\n  await IPC.render(sourceBoardName, threadNumber, threadNumber, 'delete');\n  return {\n    boardName: targetBoardName,\n    threadNumber: thread.number\n  };\n}\n\nexport async function setThreadFixed(boardName, threadNumber, fixed) {\n  let thread = await getThread(boardName, threadNumber);\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  fixed = !!fixed;\n  if (fixed === !!thread.fixed) {\n    return;\n  }\n  thread.fixed = fixed;\n  await Threads.setOne(threadNumber, thread, boardName);\n  await IPC.render(boardName, threadNumber, threadNumber, 'edit');\n}\n\nexport async function setThreadClosed(boardName, threadNumber, closed) {\n  let thread = await getThread(boardName, threadNumber);\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  closed = !!closed;\n  if (closed === !!thread.closed) {\n    return;\n  }\n  thread.closed = closed;\n  await Threads.setOne(threadNumber, thread, boardName);\n  await IPC.render(boardName, threadNumber, threadNumber, 'edit');\n}\n\nexport async function setThreadUnbumpable(boardName, threadNumber, unbumpable) {\n  let thread = await getThread(boardName, threadNumber);\n  if (!thread) {\n    throw new Error(Tools.translate('No such thread'));\n  }\n  unbumpable = !!unbumpable;\n  if (unbumpable === !!thread.unbumpable) {\n    return;\n  }\n  thread.unbumpable = unbumpable;\n  await Threads.setOne(threadNumber, thread, boardName);\n  await IPC.render(boardName, threadNumber, threadNumber, 'edit');\n}\n"],"sourceRoot":"/source/"}