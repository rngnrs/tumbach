{"version":3,"sources":["storage/channel.js"],"names":["Channel","client","name","parse","stringify","selectParser","selectStringifier","handlers","on","channel","message","skip","Tools","series","handler","result","error","stack","data","publish","shouldSubscribe","length","push","subscribe","index","indexOf","splice","unsubscribe"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;;;;;;;IAEqBA,O;AACnB,mBAAYC,MAAZ,EAAoBC,IAApB,EAAqD;AAAA,qEAAJ,EAAI;;AAAA,QAAzBC,KAAyB,QAAzBA,KAAyB;AAAA,QAAlBC,SAAkB,QAAlBA,SAAkB;;AAAA;;AACnD,SAAKH,MAAL,GAAcA,MAAd;AACA,SAAKC,IAAL,GAAYA,IAAZ;AACA,SAAKC,KAAL,GAAa,oBAAUE,YAAV,CAAuBF,KAAvB,CAAb;AACA,SAAKC,SAAL,GAAiB,oBAAUE,iBAAV,CAA4BF,SAA5B,CAAjB;AACA,SAAKG,QAAL,GAAgB,EAAhB;AACA,SAAKN,MAAL,CAAYO,EAAZ,CAAe,SAAf;AAAA,4DAA0B,kBAAeC,OAAf,EAAwBC,OAAxB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,sBACpBD,YAAY,KAAKP,IADG;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAIxBQ,0BAAU,KAAKP,KAAL,CAAWO,OAAX,CAAV;AAJwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMlBC,8BANkB,GAMX,IANW;AAAA;AAAA,iCAOhBC,MAAMC,MAAN,CAAa,MAAKN,QAAlB;AAAA,kFAA4B,iBAAeO,OAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2CAC5BH,IAD4B;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA,6CAIbG,QAAQJ,OAAR,CAJa;;AAAA;AAI5BK,4CAJ4B;;AAKhC,0CAAIA,MAAJ,EAAY;AACVJ,+CAAO,KAAP;AACD;;AAP+B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6BAA5B;;AAAA;AAAA;AAAA;AAAA,8BAPgB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAiBtB,iCAAOK,KAAP,CAAa,aAAIC,KAAJ,gBAAb;;AAjBsB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAA1B;;AAAA;AAAA;AAAA;AAAA;AAoBD;;;;;8EAEaC,I;;;;;;uBACC,KAAKjB,MAAL,CAAYkB,OAAZ,CAAoB,KAAKjB,IAAzB,EAA+B,KAAKE,SAAL,CAAec,IAAf,CAA/B,C;;;;;;;;;;;;;;;;;;;;;;8EAGCJ,O;;;;;;AACVM,+B,GAAmB,KAAKb,QAAL,CAAcc,MAAd,IAAwB,C;;sBAC3C,OAAOP,OAAP,KAAmB,U;;;;;;;;AAGvB,qBAAKP,QAAL,CAAce,IAAd,CAAmBR,OAAnB;;qBACIM,e;;;;;;uBACW,KAAKnB,MAAL,CAAYsB,SAAZ,CAAsB,KAAKrB,IAA3B,C;;;;;;;;;;;;;;;;;;;;;;8EAICY,O;;;;;;sBACZ,OAAOA,OAAP,KAAmB,W;;;;;AACrB,qBAAKP,QAAL,GAAgB,EAAhB;;;;;sBACS,OAAOO,OAAP,KAAmB,U;;;;;AACxBU,qB,GAAQ,KAAKjB,QAAL,CAAckB,OAAd,CAAsBX,OAAtB,C;;sBACRU,QAAQ,C;;;;;;;;AAGZ,qBAAKjB,QAAL,CAAcmB,MAAd,CAAqBF,KAArB,EAA4B,CAA5B;;;sBAEE,KAAKjB,QAAL,CAAcc,MAAd,IAAwB,C;;;;;;uBACb,KAAKpB,MAAL,CAAY0B,WAAZ,CAAwB,KAAKzB,IAA7B,C;;;;;;;;;;;;;;;;;;;;;;;;kBAvDEF,O","file":"storage/channel.js","sourcesContent":["import CommonKey from './common-key';\nimport Logger from '../helpers/logger';\n\nexport default class Channel {\n  constructor(client, name, { parse, stringify } = {}) {\n    this.client = client;\n    this.name = name;\n    this.parse = CommonKey.selectParser(parse);\n    this.stringify = CommonKey.selectStringifier(stringify);\n    this.handlers = [];\n    this.client.on('message', async function(channel, message) {\n      if (channel !== this.name) {\n        return;\n      }\n      message = this.parse(message);\n      try {\n        let skip = true;\n        await Tools.series(this.handlers, async function(handler) {\n          if (skip) {\n            return;\n          }\n          let result = await handler(message);\n          if (result) {\n            skip = false;\n          }\n        });\n      } catch (err) {\n        Logger.error(err.stack || err);\n      }\n    });\n  }\n\n  async publish(data) {\n    return await this.client.publish(this.name, this.stringify(data));\n  }\n\n  async subscribe(handler) {\n    let shouldSubscribe = (this.handlers.length <= 0);\n    if (typeof handler !== 'function') {\n      return;\n    }\n    this.handlers.push(handler);\n    if (shouldSubscribe) {\n      return await this.client.subscribe(this.name);\n    }\n  }\n\n  async unsubscribe(handler) {\n    if (typeof handler === 'undefined') {\n      this.handlers = [];\n    } else if (typeof handler === 'function') {\n      let index = this.handlers.indexOf(handler);\n      if (index < 0) {\n        return;\n      }\n      this.handlers.splice(index, 1);\n    }\n    if (this.handlers.length <= 0) {\n      return await this.client.unsubscribe(this.name);\n    }\n  }\n}\n"],"sourceRoot":"/source/"}